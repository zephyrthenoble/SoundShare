{% extends "base.html" %}

{% block title %}Edit Static Playlist - SoundShare{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Edit Static Playlist</h1>
                <p class="text-muted">Modify playlist details and song selection</p>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-warning" onclick="clearAllSongs()" id="clearAllBtn">
                    <i class="fas fa-trash-alt"></i> Clear All
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="goBackToPlaylist()" id="backBtn">
                    <i class="fas fa-arrow-left"></i> Back to Playlist
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Playlist Details and Options -->
<div class="row mb-4">
    <!-- Playlist Details -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Playlist Details</h5>
            </div>
            <div class="card-body">
                <form id="playlistForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="playlistName" class="form-label">Playlist Name *</label>
                                <input type="text" class="form-control" id="playlistName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="playlistDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="playlistDescription" rows="1"></textarea>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-success" onclick="savePlaylist()" id="saveBtn">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Playlist Options -->
    <div class="col-lg-6">
        {% set playlist_type = 'static' %}
        {% include 'components/playlist_options.html' %}
    </div>
</div>

<div class="row">
    <!-- Current Songs Section -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Current Songs</h5>
                        <small class="text-muted">Drag to reorder • <span id="currentCount">0</span> songs in playlist</small>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#currentSongsSection">
                        <i class="fas fa-chevron-up" id="currentSongsToggle"></i>
                    </button>
                </div>
            </div>
            <div class="collapse show" id="currentSongsSection">
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <!-- Filter Controls -->
                    {% set search_id = 'currentSongsSearch' %}
                    {% set sort_id = 'currentSongsSort' %}
                    {% set tag_filter_id = 'currentSongsTagFilter' %}
                    {% set filter_function = 'filterCurrentSongs()' %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-sm" id="currentSongsSearch" placeholder="Search current songs..." onkeyup="filterCurrentSongs()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="currentSongsSort" onchange="filterCurrentSongs()">
                                <option value="order">Playlist Order</option>
                                <option value="name">Sort by Name</option>
                                <option value="artist">Sort by Artist</option>
                                <option value="album">Sort by Album</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="currentSongsTagFilter" onchange="filterCurrentSongs()">
                                <option value="">All Tags</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="currentSongsContainer" class="sortable-container" style="min-height: 100px;">
                        <div class="text-muted text-center py-3">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Song Preview Section -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Song Preview</h5>
                        <small class="text-muted">Search and select songs to add to your playlist</small>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#songPreviewSection">
                        <i class="fas fa-chevron-up" id="songPreviewToggle"></i>
                    </button>
                </div>
            </div>
            <div class="collapse show" id="songPreviewSection">
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                <!-- Advanced Filters -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Search Songs</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Search by name, artist, album..." onkeyup="applyFilters()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Include Tags</label>
                        <select class="form-select" id="includeTagFilter" onchange="applyFilters()">
                            <option value="">All songs</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Exclude Tags</label>
                        <select class="form-select" id="excludeTagFilter" onchange="applyFilters()">
                            <option value="">No exclusions</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Sort By</label>
                        <select class="form-select" id="sortFilter" onchange="applyFilters()">
                            <option value="name">Name</option>
                            <option value="artist">Artist</option>
                            <option value="energy">Energy (High to Low)</option>
                            <option value="valence">Valence (High to Low)</option>
                            <option value="danceability">Danceability (High to Low)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Energy Range</label>
                        <select class="form-select" id="energyFilter" onchange="applyFilters()">
                            <option value="">Any Energy</option>
                            <option value="high">High Energy (70%+)</option>
                            <option value="medium">Medium Energy (30-70%)</option>
                            <option value="low">Low Energy (0-30%)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Mood Range</label>
                        <select class="form-select" id="valenceFilter" onchange="applyFilters()">
                            <option value="">Any Mood</option>
                            <option value="positive">Positive (70%+)</option>
                            <option value="neutral">Neutral (30-70%)</option>
                            <option value="melancholy">Melancholy (0-30%)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Actions</label>
                        <div class="d-grid">
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">Clear Filters</button>
                        </div>
                    </div>
                </div>
                
                <!-- Song Results -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span id="songCount" class="text-muted">0 songs</span>
                    <div>
                        <button class="btn btn-sm btn-outline-success" onclick="addAllVisible()">Add All Visible</button>
                    </div>
                </div>
                
                <div id="songResults" class="row">
                    <!-- Songs will be displayed here -->
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Song pagination" class="mt-4">
                    <ul class="pagination justify-content-center" id="songPagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
                </div>
            </div>
        </div>
    </div>
</div>

{% set show_add_button = true %}
{% include 'components/song_info_modal.html' %}

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Success
                </h5>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                <h6 class="mt-3">Playlist updated successfully!</h6>
                <p class="text-muted mb-0">Your changes have been saved.</p>
            </div>
        </div>
    </div>
</div>

<!-- Add SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
let playlistId = null;
let allSongs = [];
let allTags = [];
let playlistSongs = [];
let currentSongs = [];
let currentModalSong = null;

// Pagination variables
let currentPage = 1;
let songsPerPage = 12;

// Sortable instances
let currentSongsSortable = null;

// Playback settings
let shuffleEnabled = false;
let autoPlayEnabled = false;

document.addEventListener('DOMContentLoaded', function() {
    const urlParts = window.location.pathname.split('/');
    playlistId = urlParts[urlParts.length - 1]; // Extract ID from URL like /playlists/edit/123
    
    if (!playlistId || isNaN(parseInt(playlistId))) {
        alert('No valid playlist ID provided');
        window.location.href = '/playlists';
        return;
    }
    
    // Initialize preview audio player
    previewAudioPlayer = document.getElementById('previewAudioPlayer');
    
    // Setup collapse toggle icons
    setupCollapseToggles();
    
    loadAllData();
});

async function loadAllData() {
    try {
        // Load playlist details
        const playlistResponse = await fetch(`/api/playlists/${playlistId}`);
        if (!playlistResponse.ok) {
            throw new Error('Playlist not found');
        }
        const playlist = await playlistResponse.json();
        
        // Populate form
        document.getElementById('playlistName').value = playlist.name;
        document.getElementById('playlistDescription').value = playlist.description || '';
        currentSongs = playlist.songs || [];
        
        // Set playback settings
        shuffleEnabled = playlist.shuffle_enabled || false;
        autoPlayEnabled = playlist.auto_play_enabled || false;
        document.getElementById('shuffleEnabled').checked = shuffleEnabled;
        document.getElementById('autoPlayEnabled').checked = autoPlayEnabled;
        
        // Load all songs
        const songsResponse = await fetch('/api/songs/');
        allSongs = await songsResponse.json();
        
        // Load tags
        const tagsResponse = await fetch('/api/tags/');
        allTags = await tagsResponse.json();
        
        // Initialize
        populateFilterSelectors();
        updateCurrentSongs();
        applyFilters();
        
    } catch (error) {
        console.error('Error loading data:', error);
        alert('Error loading playlist. Returning to playlists page.');
        window.location.href = '/playlists';
    }
}

function populateFilterSelectors() {
    const includeSelect = document.getElementById('includeTagFilter');
    const excludeSelect = document.getElementById('excludeTagFilter');
    
    // Clear and populate tag filters
    includeSelect.innerHTML = '<option value="">All songs</option>';
    excludeSelect.innerHTML = '<option value="">No exclusions</option>';
    
    allTags.forEach(tag => {
        const includeOption = document.createElement('option');
        includeOption.value = tag.id;
        includeOption.textContent = tag.name;
        includeSelect.appendChild(includeOption);
        
        const excludeOption = document.createElement('option');
        excludeOption.value = tag.id;
        excludeOption.textContent = tag.name;
        excludeSelect.appendChild(excludeOption);
    });
}

function updateCurrentSongs() {
    const container = document.getElementById('currentSongsContainer');
    const countElement = document.getElementById('currentCount');
    
    countElement.textContent = currentSongs.length;
    
    populateCurrentSongsTagFilter();
    filterCurrentSongs();
}

function populateCurrentSongsTagFilter() {
    const tagFilter = document.getElementById('currentSongsTagFilter');
    const uniqueTags = new Set();
    
    currentSongs.forEach(song => {
        if (song.tags) {
            song.tags.forEach(tag => uniqueTags.add(tag.name));
        }
    });
    
    tagFilter.innerHTML = '<option value="">All Tags</option>';
    Array.from(uniqueTags).sort().forEach(tagName => {
        const option = document.createElement('option');
        option.value = tagName;
        option.textContent = tagName;
        tagFilter.appendChild(option);
    });
}

function filterCurrentSongs() {
    const container = document.getElementById('currentSongsContainer');
    const searchTerm = document.getElementById('currentSongsSearch').value.toLowerCase();
    const sortBy = document.getElementById('currentSongsSort').value;
    const tagFilter = document.getElementById('currentSongsTagFilter').value;
    
    if (currentSongs.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3">No songs in playlist</div>';
        return;
    }
    
    // Filter songs
    let filteredSongs = currentSongs.filter(song => {
        const matchesSearch = searchTerm === '' || 
            song.display_name.toLowerCase().includes(searchTerm) ||
            (song.artist || '').toLowerCase().includes(searchTerm) ||
            (song.album || '').toLowerCase().includes(searchTerm);
        
        const matchesTag = tagFilter === '' || 
            (song.tags && song.tags.some(tag => tag.name === tagFilter));
        
        return matchesSearch && matchesTag;
    });
    
    // Sort songs
    if (sortBy !== 'order') {
        filteredSongs.sort((a, b) => {
            switch (sortBy) {
                case 'name':
                    return (a.display_name || '').localeCompare(b.display_name || '');
                case 'artist':
                    return (a.artist || '').localeCompare(b.artist || '');
                case 'album':
                    return (a.album || '').localeCompare(b.album || '');
                default:
                    return 0;
            }
        });
    }
    
    container.innerHTML = filteredSongs.map((song, index) => `
        <div class="song-item card mb-2" data-song-id="${song.id}" data-index="${index}">
            <div class="card-body p-2">
                <div class="d-flex align-items-center">
                    <div class="drag-handle me-3" style="cursor: move;" title="Drag to reorder">
                        <i class="fas fa-grip-vertical text-muted"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${song.display_name}</div>
                        <div class="text-muted small">${song.album || 'Unknown Album'} • ${getFolder(song.file_path) || 'Unknown Folder'}</div>
                        ${song.tags && song.tags.length > 0 ? `
                            <div class="mt-1">
                                ${song.tags.map(tag => `<span class="badge bg-secondary me-1" style="font-size: 0.65em;">${tag.name}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <div class="media-controls">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="playPreview(${song.id})" id="previewBtn-${song.id}" title="Play Preview">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="showSongInfo(${song.id})" title="Song Info">
                                    <i class="fas fa-info"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSongFromPlaylist(${song.id})" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Progress bar for preview (hidden by default) -->
                <div class="preview-progress mt-2" id="progress-${song.id}" style="display: none;">
                    <div class="progress" style="height: 3px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted mt-1">
                        <span id="currentTime-${song.id}">0:00</span>
                        <span id="totalTime-${song.id}">0:00</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    // Reinitialize sortable after filtering (only if not sorted)
    if (sortBy === 'order') {
        initializeSortable();
    }
}

function applyFilters() {
    const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
    const includeTagId = parseInt(document.getElementById('includeTagFilter').value) || null;
    const excludeTagId = parseInt(document.getElementById('excludeTagFilter').value) || null;
    const sortBy = document.getElementById('sortFilter').value;
    const energyRange = document.getElementById('energyFilter').value;
    const valenceRange = document.getElementById('valenceFilter').value;
    
    // Get IDs of songs already in playlist
    const currentSongIds = currentSongs.map(song => song.id);
    
    filteredSongs = allSongs.filter(song => {
        // Don't show songs already in playlist
        if (currentSongIds.includes(song.id)) {
            return false;
        }
        
        // Search filter
        if (searchTerm) {
            const searchFields = [
                song.display_name?.toLowerCase() || '',
                song.artist?.toLowerCase() || '',
                song.album?.toLowerCase() || '',
                song.filename?.toLowerCase() || ''
            ].join(' ');
            
            if (!searchFields.includes(searchTerm)) {
                return false;
            }
        }
        
        // Include tag filter
        if (includeTagId) {
            const songTagIds = song.tags ? song.tags.map(tag => tag.id) : [];
            if (!songTagIds.includes(includeTagId)) {
                return false;
            }
        }
        
        // Exclude tag filter
        if (excludeTagId) {
            const songTagIds = song.tags ? song.tags.map(tag => tag.id) : [];
            if (songTagIds.includes(excludeTagId)) {
                return false;
            }
        }
        
        // Energy filter
        if (energyRange) {
            const energy = song.energy || 0;
            switch(energyRange) {
                case 'high': if (energy < 0.7) return false; break;
                case 'medium': if (energy < 0.3 || energy >= 0.7) return false; break;
                case 'low': if (energy >= 0.3) return false; break;
            }
        }
        
        // Valence filter
        if (valenceRange) {
            const valence = song.valence || 0;
            switch(valenceRange) {
                case 'positive': if (valence < 0.7) return false; break;
                case 'neutral': if (valence < 0.3 || valence >= 0.7) return false; break;
                case 'melancholy': if (valence >= 0.3) return false; break;
            }
        }
        
        return true;
    });
    
    // Sort songs
    filteredSongs.sort((a, b) => {
        switch (sortBy) {
            case 'name':
                return (a.display_name || '').localeCompare(b.display_name || '');
            case 'artist':
                return (a.artist || '').localeCompare(b.artist || '');
            case 'energy':
                return (b.energy || 0) - (a.energy || 0);
            case 'valence':
                return (b.valence || 0) - (a.valence || 0);
            case 'danceability':
                return (b.danceability || 0) - (a.danceability || 0);
            default:
                return 0;
        }
    });
    
    currentPage = 1;
    renderSongResults();
    renderPagination();
    updateSongCount();
}

function renderSongResults() {
    const startIndex = (currentPage - 1) * songsPerPage;
    const endIndex = startIndex + songsPerPage;
    const pagesSongs = filteredSongs.slice(startIndex, endIndex);
    
    const container = document.getElementById('songResults');
    container.innerHTML = '';
    
    if (pagesSongs.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">No songs available to add</div>';
        return;
    }
    
    pagesSongs.forEach(song => {
        const songElement = document.createElement('div');
        songElement.innerHTML = `
            <div class="song-item card mb-2" data-song-id="${song.id}">
                <div class="card-body p-2">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="fw-bold">${song.display_name}</div>
                            <div class="text-muted small">${song.album || 'Unknown Album'} • ${getFolder(song.file_path) || 'Unknown Folder'}</div>
                            ${song.tags && song.tags.length > 0 ? `
                                <div class="mt-1">
                                    ${song.tags.map(tag => `<span class="badge bg-secondary me-1" style="font-size: 0.65em;">${tag.name}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="media-controls">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="playPreview(${song.id})" id="previewBtn-${song.id}" title="Play Preview">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="showSongInfo(${song.id})" title="Song Info">
                                        <i class="fas fa-info"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="addSongToPlaylist(${song.id})" title="Add to Playlist">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Progress bar for preview (hidden by default) -->
                    <div class="preview-progress mt-2" id="progress-${song.id}" style="display: none;">
                        <div class="progress" style="height: 3px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between small text-muted mt-1">
                            <span id="currentTime-${song.id}">0:00</span>
                            <span id="totalTime-${song.id}">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(songElement);
    });
}

function renderPagination() {
    const totalPages = Math.ceil(filteredSongs.length / songsPerPage);
    const pagination = document.getElementById('songPagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers (show max 5 pages around current)
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
    pagination.appendChild(nextLi);
}

function changePage(page) {
    const totalPages = Math.ceil(filteredSongs.length / songsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderSongResults();
        renderPagination();
        // Scroll to top of results
        document.getElementById('songResults').scrollIntoView({ behavior: 'smooth' });
    }
}

function updateSongCount() {
    document.getElementById('songCount').textContent = `${filteredSongs.length} songs available`;
}

function clearFilters() {
    document.getElementById('searchFilter').value = '';
    document.getElementById('includeTagFilter').value = '';
    document.getElementById('excludeTagFilter').value = '';
    document.getElementById('sortFilter').value = 'name';
    document.getElementById('energyFilter').value = '';
    document.getElementById('valenceFilter').value = '';
    applyFilters();
}

async function addSongToPlaylist(songId) {
    try {
        const response = await fetch(`/api/playlists/${playlistId}/songs/${songId}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to add song');
        }
        
        // Find and add the song to current songs
        const song = allSongs.find(s => s.id === songId);
        if (song) {
            currentSongs.push(song);
            updateCurrentSongs();
            applyFilters(); // This will remove the song from available songs
        }
        
    } catch (error) {
        console.error('Error adding song:', error);
        alert('Error adding song to playlist');
    }
}

async function removeSongFromPlaylist(songId) {
    if (!confirm('Remove this song from the playlist?')) return;
    
    try {
        const response = await fetch(`/api/playlists/${playlistId}/songs/${songId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to remove song');
        }
        
        // Remove the song from current songs
        currentSongs = currentSongs.filter(song => song.id !== songId);
        updateCurrentSongs();
        applyFilters(); // This will add the song back to available songs
        
    } catch (error) {
        console.error('Error removing song:', error);
        alert('Error removing song from playlist');
    }
}

function addAllVisible() {
    if (filteredSongs.length === 0) return;
    
    if (!confirm(`Add all ${filteredSongs.length} visible songs to the playlist?`)) return;
    
    // Add songs in batches to avoid overwhelming the server
    addSongsInBatches(filteredSongs.map(s => s.id));
}

async function addSongsInBatches(songIds) {
    const batchSize = 5;
    const totalBatches = Math.ceil(songIds.length / batchSize);
    
    for (let i = 0; i < totalBatches; i++) {
        const batch = songIds.slice(i * batchSize, (i + 1) * batchSize);
        
        try {
            await Promise.all(
                batch.map(songId => 
                    fetch(`/api/playlists/${playlistId}/songs/${songId}`, {
                        method: 'POST'
                    })
                )
            );
            
            // Add songs to current songs
            batch.forEach(songId => {
                const song = allSongs.find(s => s.id === songId);
                if (song && !currentSongs.find(s => s.id === songId)) {
                    currentSongs.push(song);
                }
            });
            
        } catch (error) {
            console.error('Error adding batch:', error);
            alert(`Error adding some songs. ${i * batchSize} songs were added successfully.`);
            break;
        }
    }
    
    updateCurrentSongs();
    applyFilters();
}

function removeAllSongs() {
    if (currentSongs.length === 0) return;
    
    if (!confirm(`Remove all ${currentSongs.length} songs from the playlist?`)) return;
    
    removeSongsInBatches(currentSongs.map(s => s.id));
}

async function removeSongsInBatches(songIds) {
    const batchSize = 5;
    const totalBatches = Math.ceil(songIds.length / batchSize);
    
    for (let i = 0; i < totalBatches; i++) {
        const batch = songIds.slice(i * batchSize, (i + 1) * batchSize);
        
        try {
            await Promise.all(
                batch.map(songId => 
                    fetch(`/api/playlists/${playlistId}/songs/${songId}`, {
                        method: 'DELETE'
                    })
                )
            );
            
        } catch (error) {
            console.error('Error removing batch:', error);
            alert(`Error removing some songs.`);
            break;
        }
    }
    
    currentSongs = [];
    updateCurrentSongs();
    applyFilters();
}

function updatePlaybackSettings() {
    shuffleEnabled = document.getElementById('shuffleEnabled').checked;
    autoPlayEnabled = document.getElementById('autoPlayEnabled').checked;
}

async function savePlaylist() {
    const name = document.getElementById('playlistName').value.trim();
    const description = document.getElementById('playlistDescription').value.trim();
    
    if (!name) {
        alert('Please enter a playlist name');
        document.getElementById('playlistName').focus();
        return;
    }
    
    try {
        const playlistData = { 
            name, 
            description,
            shuffle_enabled: shuffleEnabled,
            auto_play_enabled: autoPlayEnabled
        };
        const response = await fetch(`/api/playlists/${playlistId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(playlistData)
        });
        
        if (!response.ok) {
            throw new Error('Failed to update playlist');
        }
        
        // Show success modal instead of alert and redirect
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        successModal.show();
        
        // Auto-hide the modal after 2 seconds
        setTimeout(() => {
            successModal.hide();
        }, 2000);
        
        // Reset save button to original state
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
        saveBtn.classList.remove('btn-warning');
        saveBtn.classList.add('btn-success');
        
    } catch (error) {
        console.error('Error updating playlist:', error);
        alert('Error updating playlist. Please try again.');
    }
}

function goBackToPlaylist() {
    if (playlistId) {
        window.location.href = `/playlists/${playlistId}`;
    } else {
        window.location.href = '/playlists';
    }
}

async function deletePlaylist() {
    if (!confirm('Are you sure you want to delete this playlist? This action cannot be undone.')) return;
    
    try {
        const playlistName = document.getElementById('playlistName').value;
        
        const response = await fetch(`/api/playlists/${playlistId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete playlist');
        }
        
        // Redirect to playlists page with undo notification
        sessionStorage.setItem('deletedPlaylist', JSON.stringify({
            name: playlistName,
            type: 'static',
            timestamp: Date.now()
        }));
        
        window.location.href = '/playlists';
        
    } catch (error) {
        console.error('Error deleting playlist:', error);
        alert('Error deleting playlist. Please try again.');
    }
}

// Initialize SortableJS for drag and drop reordering
function initializeSortable() {
    const container = document.getElementById('currentSongsContainer');
    
    // Destroy existing sortable instance if it exists
    if (container.sortable) {
        container.sortable.destroy();
    }
    
    // Only create sortable if we have songs
    if (currentSongs.length === 0) {
        return;
    }
    
    container.sortable = new Sortable(container, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        onEnd: function(evt) {
            // Reorder the currentSongs array
            const movedSong = currentSongs.splice(evt.oldIndex, 1)[0];
            currentSongs.splice(evt.newIndex, 0, movedSong);
            
            // Update the display (this will reinitialize sortable)
            updateCurrentSongs();
            
            // Mark as modified
            markAsModified();
        }
    });
}

// Mark the playlist as modified
function markAsModified() {
    const saveBtn = document.getElementById('saveBtn');
    if (!saveBtn.textContent.includes('*')) {
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes *';
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-warning');
    }
}

// Setup collapse toggle icons
function setupCollapseToggles() {
    const currentSongsSection = document.getElementById('currentSongsSection');
    const songPreviewSection = document.getElementById('songPreviewSection');
    
    currentSongsSection.addEventListener('shown.bs.collapse', function () {
        document.getElementById('currentSongsToggle').className = 'fas fa-chevron-up';
    });
    
    currentSongsSection.addEventListener('hidden.bs.collapse', function () {
        document.getElementById('currentSongsToggle').className = 'fas fa-chevron-down';
    });
    
    songPreviewSection.addEventListener('shown.bs.collapse', function () {
        document.getElementById('songPreviewToggle').className = 'fas fa-chevron-up';
    });
    
    songPreviewSection.addEventListener('hidden.bs.collapse', function () {
        document.getElementById('songPreviewToggle').className = 'fas fa-chevron-down';
    });
}

// Media player functions
function playPreview(songId) {
    // Stop current preview if any
    stopCurrentPreview();
    
    const song = allSongs.find(s => s.id === songId);
    if (!song) return;
    
    currentlyPreviewingSong = songId;
    
    // Update button to show playing state
    const btn = document.getElementById(`previewBtn-${songId}`);
    btn.innerHTML = '<i class="fas fa-pause"></i>';
    btn.onclick = () => stopPreview(songId);
    
    // Show progress bar
    const progress = document.getElementById(`progress-${songId}`);
    if (progress) {
        progress.style.display = 'block';
    }
    
    // Setup audio
    previewAudioPlayer.src = `/api/songs/${songId}/preview`;
    previewAudioPlayer.currentTime = 0;
    
    // Setup event listeners
    previewAudioPlayer.onloadedmetadata = () => {
        updateTimeDisplay(songId);
    };
    
    previewAudioPlayer.ontimeupdate = () => {
        updateProgress(songId);
        updateTimeDisplay(songId);
    };
    
    previewAudioPlayer.onended = () => {
        stopPreview(songId);
    };
    
    previewAudioPlayer.onerror = () => {
        console.error('Audio preview error for song', songId);
        stopPreview(songId);
    };
    
    previewAudioPlayer.play();
}

function stopPreview(songId) {
    if (!songId) songId = currentlyPreviewingSong;
    if (!songId) return;
    
    previewAudioPlayer.pause();
    previewAudioPlayer.src = '';
    
    // Reset button
    const btn = document.getElementById(`previewBtn-${songId}`);
    if (btn) {
        btn.innerHTML = '<i class="fas fa-play"></i>';
        btn.onclick = () => playPreview(songId);
    }
    
    // Hide progress bar
    const progress = document.getElementById(`progress-${songId}`);
    if (progress) {
        progress.style.display = 'none';
    }
    
    currentlyPreviewingSong = null;
}

function stopCurrentPreview() {
    if (currentlyPreviewingSong) {
        stopPreview(currentlyPreviewingSong);
    }
}

function updateProgress(songId) {
    if (!previewAudioPlayer.duration) return;
    
    const progress = (previewAudioPlayer.currentTime / previewAudioPlayer.duration) * 100;
    const progressBar = document.querySelector(`#progress-${songId} .progress-bar`);
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
}

function updateTimeDisplay(songId) {
    const currentTimeEl = document.getElementById(`currentTime-${songId}`);
    const totalTimeEl = document.getElementById(`totalTime-${songId}`);
    
    if (currentTimeEl) {
        currentTimeEl.textContent = formatTime(previewAudioPlayer.currentTime);
    }
    
    if (totalTimeEl) {
        totalTimeEl.textContent = formatTime(previewAudioPlayer.duration);
    }
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Song info modal functions
function showSongInfo(songId) {
    const song = allSongs.find(s => s.id === songId);
    if (!song) return;
    
    currentModalSong = song;
    
    // Populate modal with song information
    document.getElementById('modalSongTitle').textContent = song.display_name || '-';
    document.getElementById('modalSongArtist').textContent = song.artist || '-';
    document.getElementById('modalSongAlbum').textContent = song.album || '-';
    document.getElementById('modalSongTrack').textContent = song.track_number ? `Track ${song.track_number}` : '-';
    document.getElementById('modalSongDuration').textContent = song.duration ? formatTime(song.duration) : '-';
    
    // Audio features
    document.getElementById('modalSongEnergy').textContent = song.energy ? `${(song.energy * 100).toFixed(1)}%` : '-';
    document.getElementById('modalSongValence').textContent = song.valence ? `${(song.valence * 100).toFixed(1)}%` : '-';
    document.getElementById('modalSongDanceability').textContent = song.danceability ? `${(song.danceability * 100).toFixed(1)}%` : '-';
    
    // Tags
    const tagsContainer = document.getElementById('modalSongTags');
    if (song.tags && song.tags.length > 0) {
        tagsContainer.innerHTML = song.tags.map(tag => 
            `<span class="badge bg-secondary me-1">${tag.name}</span>`
        ).join('');
    } else {
        tagsContainer.innerHTML = '<span class="text-muted">No tags</span>';
    }
    
    // File information
    document.getElementById('modalSongPath').textContent = song.file_path || '-';
    document.getElementById('modalSongSize').textContent = song.file_size ? formatFileSize(song.file_size) : '-';
    
    // Show/hide add to playlist button based on whether song is already in playlist
    const addBtn = document.getElementById('modalAddToPlaylist');
    const isInPlaylist = currentSongs.some(s => s.id === songId);
    if (isInPlaylist) {
        addBtn.style.display = 'none';
    } else {
        addBtn.style.display = 'inline-block';
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('songPreviewModal'));
    modal.show();
}

function addSongToPlaylistFromModal() {
    if (currentModalSong) {
        addSongToPlaylist(currentModalSong.id);
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('songPreviewModal'));
        modal.hide();
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Helper function to extract folder name from file path
function getFolder(filePath) {
    if (!filePath) return '';
    const parts = filePath.split('/');
    return parts.length > 1 ? parts[parts.length - 2] : '';
}

// Helper function to extract folder name from file path
function getFolder(filePath) {
    if (!filePath) return '';
    const parts = filePath.split('/');
    return parts.length > 1 ? parts[parts.length - 2] : '';
}
</script>

<style>
.sortable-ghost {
    opacity: 0.4;
}

.sortable-chosen {
    transform: scale(1.02);
}

.sortable-drag {
    transform: rotate(5deg);
}

.drag-handle:hover {
    color: #007bff !important;
}

.sortable-container {
    min-height: 100px;
}

.song-item {
    transition: all 0.2s ease;
}

.song-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.media-controls {
    transition: opacity 0.2s ease;
}

.preview-progress {
    transition: all 0.3s ease;
}

.btn-group .btn {
    border-radius: 0.25rem !important;
}

.card-header [data-bs-toggle="collapse"] {
    cursor: pointer;
}

.card-header [data-bs-toggle="collapse"]:hover {
    background-color: rgba(0,0,0,0.05);
    border-radius: 0.25rem;
}
</style>
{% endblock %}
