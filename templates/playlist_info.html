{% extends "base.html" %}

{% block title %}Playlist Info - SoundShare{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 id="playlistTitle">Loading...</h1>
                <p class="text-muted" id="playlistDescription">Loading playlist information...</p>
            </div>
            <div>
                <a href="/playlists" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left"></i> Back to Playlists
                </a>
                <a href="#" id="editPlaylistBtn" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Edit Playlist
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Media Player Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Media Player</h5>
            </div>
            <div class="card-body">
                <!-- Current Song Display -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div id="currentSongInfo" class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-music fa-2x text-muted"></i>
                            </div>
                            <div>
                                <h6 class="mb-1" id="currentSongTitle">No song selected</h6>
                                <small class="text-muted" id="currentSongArtist">Select a song to start playing</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-secondary" id="shuffleBtn" onclick="toggleShuffle()" title="Toggle Shuffle">
                                <i class="fas fa-random"></i>
                            </button>
                            <button class="btn btn-outline-secondary" id="autoplayBtn" onclick="toggleAutoplay()" title="Toggle Autoplay">
                                <i class="fas fa-forward"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Player Controls -->
                <div class="text-center mb-3">
                    <div class="btn-group" role="group">
                        <button class="btn btn-secondary" onclick="previousSong()" id="prevBtn" disabled>
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="skipBackward()" id="skipBackBtn" disabled>
                            <i class="fas fa-backward"></i> 20s
                        </button>
                        <button class="btn btn-success btn-lg" onclick="togglePlayPause()" id="playPauseBtn">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="skipForward()" id="skipForwardBtn" disabled>
                            20s <i class="fas fa-forward"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="nextSong()" id="nextBtn" disabled>
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>
                </div>

                <!-- Progress and Time -->
                <div class="row">
                    <div class="col-2 text-center">
                        <small id="currentTime">0:00</small>
                    </div>
                    <div class="col-8">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-2 text-center">
                        <small id="totalTime">0:00</small>
                    </div>
                </div>

                <!-- Hidden Audio Element -->
                <audio id="audioPlayer" style="display: none;"></audio>
            </div>
        </div>
    </div>
</div>

<!-- Playlist Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="totalSongs">0</h5>
                <p class="card-text text-muted">Total Songs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="sessionPlayed">0</h5>
                <p class="card-text text-muted">Played This Session</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="playlistProgress">0</h5>
                <p class="card-text text-muted">Playlist Progress</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <button class="btn btn-outline-primary" onclick="resetPlaylistTracking()">
                    <i class="fas fa-refresh"></i> Reset Progress
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Song Lists -->
<div class="row">
    <!-- Current Playlist -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Playlist Songs</h5>
                <small class="text-muted">Drag to reorder</small>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <div id="playlistSongs" class="sortable-list">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading songs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session History -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Session History</h5>
                <small class="text-muted">Recently played songs</small>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <div id="sessionHistory">
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-history fa-2x mb-2"></i>
                        <p>No songs played yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// Global variables
let playlistId = null;
let playlist = null;
let songs = [];
let currentSongIndex = -1;
let isPlaying = false;
let isShuffleMode = false;
let isAutoplay = true;
let sessionHistory = [];
let playlistTracking = [];

// Audio player
let audioPlayer = null;
let progressInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    // Get playlist ID from URL
    const path = window.location.pathname;
    playlistId = parseInt(path.split('/').pop());
    
    // Initialize audio player
    audioPlayer = document.getElementById('audioPlayer');
    setupAudioEventListeners();
    
    // Load playlist data
    loadPlaylistData();
    
    // Setup sortable for drag and drop
    setupSortable();
});

async function loadPlaylistData() {
    try {
        const response = await fetch(`/api/playlists/${playlistId}`);
        if (!response.ok) {
            throw new Error('Playlist not found');
        }
        
        playlist = await response.json();
        songs = playlist.songs || [];
        
        // Update UI
        updatePlaylistInfo();
        renderPlaylistSongs();
        updateStatistics();
        
        // Set edit button link
        document.getElementById('editPlaylistBtn').href = `/playlists/edit/${playlistId}`;
        
    } catch (error) {
        console.error('Error loading playlist:', error);
        alert('Error loading playlist. Returning to playlists page.');
        window.location.href = '/playlists';
    }
}

function updatePlaylistInfo() {
    document.getElementById('playlistTitle').textContent = playlist.name;
    document.getElementById('playlistDescription').textContent = playlist.description || 'No description';
}

function renderPlaylistSongs() {
    const container = document.getElementById('playlistSongs');
    
    if (songs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-music fa-2x mb-2"></i>
                <p>No songs in this playlist</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = songs.map((song, index) => `
        <div class="song-item d-flex align-items-center p-2 mb-2 border rounded" data-song-id="${song.id}" data-index="${index}">
            <div class="drag-handle me-2" style="cursor: grab;">
                <i class="fas fa-grip-vertical text-muted"></i>
            </div>
            <div class="flex-grow-1">
                <div class="fw-bold">${song.display_name}</div>
                <small class="text-muted">${song.artist || 'Unknown Artist'}</small>
            </div>
            <div class="ms-2">
                <button class="btn btn-sm btn-outline-primary" onclick="playSong(${index})" title="Play Song">
                    <i class="fas fa-play"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function setupSortable() {
    const container = document.getElementById('playlistSongs');
    new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        handle: '.drag-handle',
        onEnd: function(evt) {
            // Reorder songs array
            const movedSong = songs.splice(evt.oldIndex, 1)[0];
            songs.splice(evt.newIndex, 0, movedSong);
            
            // Update backend
            updatePlaylistOrder();
            
            // Re-render to update indices
            renderPlaylistSongs();
        }
    });
}

async function updatePlaylistOrder() {
    try {
        const songIds = songs.map(song => song.id);
        const response = await fetch(`/api/playlists/${playlistId}/order`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ song_ids: songIds })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update playlist order');
        }
    } catch (error) {
        console.error('Error updating playlist order:', error);
    }
}

function setupAudioEventListeners() {
    audioPlayer.addEventListener('loadedmetadata', function() {
        updateTimeDisplay();
    });
    
    audioPlayer.addEventListener('timeupdate', function() {
        updateProgressBar();
        updateTimeDisplay();
    });
    
    audioPlayer.addEventListener('ended', function() {
        onSongEnded();
    });
    
    audioPlayer.addEventListener('error', function() {
        console.error('Audio playback error');
        nextSong();
    });
}

function togglePlayPause() {
    if (currentSongIndex === -1) {
        // Start playing first song
        playSong(0);
        return;
    }
    
    if (isPlaying) {
        pauseSong();
    } else {
        resumeSong();
    }
}

function playSong(index) {
    if (index < 0 || index >= songs.length) return;
    
    const song = songs[index];
    currentSongIndex = index;
    
    // Update current song display
    document.getElementById('currentSongTitle').textContent = song.display_name;
    document.getElementById('currentSongArtist').textContent = song.artist || 'Unknown Artist';
    
    // Load and play audio
    audioPlayer.src = `/api/songs/${song.id}/stream`;
    audioPlayer.play();
    isPlaying = true;
    
    // Update play button
    document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
    
    // Enable controls
    enablePlayerControls();
    
    // Add to history
    addToSessionHistory(song);
    addToPlaylistTracking(song);
    
    // Update statistics
    updateStatistics();
    
    // Highlight current song
    highlightCurrentSong();
}

function pauseSong() {
    audioPlayer.pause();
    isPlaying = false;
    document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
}

function resumeSong() {
    audioPlayer.play();
    isPlaying = true;
    document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
}

function nextSong() {
    if (songs.length === 0) return;
    
    let nextIndex;
    
    if (isShuffleMode) {
        nextIndex = getNextShuffleSong();
    } else {
        nextIndex = (currentSongIndex + 1) % songs.length;
        if (nextIndex === 0) {
            // Reached end of playlist
            resetPlaylistTracking();
        }
    }
    
    playSong(nextIndex);
}

function previousSong() {
    if (sessionHistory.length > 1) {
        // Remove current song from history
        sessionHistory.pop();
        
        // Get previous song
        const prevSong = sessionHistory[sessionHistory.length - 1];
        const prevIndex = songs.findIndex(s => s.id === prevSong.id);
        
        if (prevIndex !== -1) {
            currentSongIndex = prevIndex;
            playSong(prevIndex);
        }
    }
}

function getNextShuffleSong() {
    // Get songs not yet played in this playlist cycle
    const unplayedSongs = songs.filter(song => 
        !playlistTracking.some(tracked => tracked.id === song.id)
    );
    
    if (unplayedSongs.length === 0) {
        // All songs played, reset and start over
        resetPlaylistTracking();
        return Math.floor(Math.random() * songs.length);
    }
    
    // Pick random unplayed song
    const randomUnplayed = unplayedSongs[Math.floor(Math.random() * unplayedSongs.length)];
    return songs.findIndex(song => song.id === randomUnplayed.id);
}

function skipForward() {
    audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 20, audioPlayer.duration);
}

function skipBackward() {
    audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 20, 0);
}

function toggleShuffle() {
    isShuffleMode = !isShuffleMode;
    const shuffleBtn = document.getElementById('shuffleBtn');
    
    if (isShuffleMode) {
        shuffleBtn.classList.remove('btn-outline-secondary');
        shuffleBtn.classList.add('btn-secondary');
    } else {
        shuffleBtn.classList.remove('btn-secondary');
        shuffleBtn.classList.add('btn-outline-secondary');
    }
}

function toggleAutoplay() {
    isAutoplay = !isAutoplay;
    const autoplayBtn = document.getElementById('autoplayBtn');
    
    if (isAutoplay) {
        autoplayBtn.classList.remove('btn-outline-secondary');
        autoplayBtn.classList.add('btn-secondary');
    } else {
        autoplayBtn.classList.remove('btn-secondary');
        autoplayBtn.classList.add('btn-outline-secondary');
    }
}

function onSongEnded() {
    if (isAutoplay) {
        nextSong();
    } else {
        isPlaying = false;
        document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
    }
}

function addToSessionHistory(song) {
    sessionHistory.push({
        ...song,
        playedAt: new Date()
    });
    renderSessionHistory();
}

function addToPlaylistTracking(song) {
    if (!playlistTracking.some(tracked => tracked.id === song.id)) {
        playlistTracking.push(song);
    }
}

function resetPlaylistTracking() {
    playlistTracking = [];
    updateStatistics();
}

function renderSessionHistory() {
    const container = document.getElementById('sessionHistory');
    
    if (sessionHistory.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-history fa-2x mb-2"></i>
                <p>No songs played yet</p>
            </div>
        `;
        return;
    }
    
    const recentHistory = sessionHistory.slice(-10).reverse(); // Show last 10, most recent first
    
    container.innerHTML = recentHistory.map((entry, index) => `
        <div class="d-flex align-items-center p-2 mb-2 border rounded">
            <div class="me-2">
                <small class="badge bg-secondary">${sessionHistory.length - index}</small>
            </div>
            <div class="flex-grow-1">
                <div class="fw-bold small">${entry.display_name}</div>
                <small class="text-muted">${entry.artist || 'Unknown Artist'}</small>
            </div>
            <div class="ms-2">
                <small class="text-muted">${entry.playedAt.toLocaleTimeString()}</small>
            </div>
        </div>
    `).join('');
}

function updateStatistics() {
    document.getElementById('totalSongs').textContent = songs.length;
    document.getElementById('sessionPlayed').textContent = sessionHistory.length;
    document.getElementById('playlistProgress').textContent = `${playlistTracking.length}/${songs.length}`;
}

function enablePlayerControls() {
    document.getElementById('prevBtn').disabled = sessionHistory.length <= 1;
    document.getElementById('skipBackBtn').disabled = false;
    document.getElementById('skipForwardBtn').disabled = false;
    document.getElementById('nextBtn').disabled = songs.length <= 1;
}

function updateProgressBar() {
    if (audioPlayer.duration) {
        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }
}

function updateTimeDisplay() {
    const current = formatTime(audioPlayer.currentTime);
    const total = formatTime(audioPlayer.duration);
    
    document.getElementById('currentTime').textContent = current;
    document.getElementById('totalTime').textContent = total;
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function highlightCurrentSong() {
    // Remove previous highlights
    document.querySelectorAll('.song-item').forEach(item => {
        item.classList.remove('bg-primary', 'text-white');
    });
    
    // Highlight current song
    if (currentSongIndex >= 0) {
        const currentItem = document.querySelector(`[data-index="${currentSongIndex}"]`);
        if (currentItem) {
            currentItem.classList.add('bg-primary', 'text-white');
        }
    }
}
</script>

<style>
.sortable-ghost {
    opacity: 0.5;
}

.sortable-chosen {
    background-color: #f8f9fa;
}

.sortable-drag {
    background-color: #ffffff;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.song-item:hover {
    background-color: #f8f9fa;
}

.song-item.bg-primary:hover {
    background-color: #0d6efd !important;
}

.drag-handle:active {
    cursor: grabbing;
}
</style>
{% endblock %}
