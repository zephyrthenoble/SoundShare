{% extends "base.html" %}

{% block title %}Playlist Info - SoundShare{% endblock %}

{% block content %}
<div class="row">
    <di<!-- Smart Criteria Section -->
<div class="row mb-4" id="dynamicCriteriaSection" style="display: none;">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>Smart Criteria
                </h6>
                <button class="btn btn-sm btn-outline-primary" onclick="addDynamicCriteria()">
                    <i class="fas fa-plus me-1"></i>Add Criteria
                </button>
            </div>
            <div class="card-body">
                <div id="dynamicCriteriaList">
                    <!-- Smart criteria will be rendered here -->
                </div>
            </div>
        </div>
    </div>
</div>       <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 id="playlistTitle">Loading...</h1>
                <p class="text-muted" id="playlistDescription">Loading playlist information...</p>
            </div>
            <div>
                <a href="/playlists" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left"></i> Back to Playlists
                </a>
                <a href="#" id="editPlaylistBtn" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Edit Playlist
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Media Player Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Media Player</h5>
            </div>
            <div class="card-body">
                <!-- Current Song Display -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div id="currentSongInfo" class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-music fa-2x text-muted"></i>
                            </div>
                            <div>
                                <h6 class="mb-1" id="currentSongTitle">No song selected</h6>
                                <small class="text-muted" id="currentSongArtist">Select a song to start playing</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-secondary" id="shuffleBtn" onclick="toggleShuffle()" title="Toggle Shuffle">
                                <i class="fas fa-random"></i>
                            </button>
                            <button class="btn btn-outline-secondary" id="autoplayBtn" onclick="toggleAutoplay()" title="Toggle Autoplay">
                                <i class="fas fa-forward"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Player Controls -->
                <div class="text-center mb-3">
                    <div class="btn-group" role="group">
                        <button class="btn btn-secondary" onclick="previousSong()" id="prevBtn" disabled>
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="skipBackward()" id="skipBackBtn" disabled>
                            <i class="fas fa-backward"></i> 20s
                        </button>
                        <button class="btn btn-success btn-lg" onclick="togglePlayPause()" id="playPauseBtn">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="skipForward()" id="skipForwardBtn" disabled>
                            20s <i class="fas fa-forward"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="nextSong()" id="nextBtn" disabled>
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>
                </div>

                <!-- Progress and Time -->
                <div class="row">
                    <div class="col-2 text-center">
                        <small id="currentTime">0:00</small>
                    </div>
                    <div class="col-8">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-2 text-center">
                        <small id="totalTime">0:00</small>
                    </div>
                </div>

                <!-- Hidden Audio Element -->
                <audio id="audioPlayer" style="display: none;"></audio>
            </div>
        </div>
    </div>
</div>

<!-- Playlist Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="totalSongs">0</h5>
                <p class="card-text text-muted">Total Songs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="sessionPlayed">0</h5>
                <p class="card-text text-muted">Played This Session</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="playlistProgress">0</h5>
                <p class="card-text text-muted">Playlist Progress</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <button class="btn btn-outline-primary" onclick="resetPlaylistTracking()">
                    <i class="fas fa-refresh"></i> Reset Progress
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic Criteria Section -->
<div class="row mb-4" id="dynamicCriteriaSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Dynamic Criteria
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="addDynamicCriteria()">
                    <i class="fas fa-plus"></i> Add Criteria
                </button>
            </div>
            <div class="card-body">
                <div id="dynamicCriteriaList">
                    <!-- Dynamic criteria will be rendered here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Song Lists -->
<div class="row">
    <!-- Current Playlist -->
    <div class="col-lg-8" id="playlistSongsCol">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Playlist Songs</h5>
                <small class="text-muted">Drag to reorder</small>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <div id="playlistSongs" class="sortable-list">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading songs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session History -->
    <div class="col-lg-4" id="sessionHistoryCol">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#sessionHistoryCollapse" aria-expanded="true" style="cursor: pointer;">
                <div>
                    <h5 class="mb-0">Session History</h5>
                    <small class="text-muted">Recently played songs</small>
                </div>
                <i class="fas fa-chevron-left" id="historyChevron"></i>
            </div>
            <div class="collapse collapse-horizontal show" id="sessionHistoryCollapse">
                <div class="card-body" style="max-height: 500px; overflow-y: auto; min-width: 300px;">
                    <div id="sessionHistory">
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p>No songs played yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Song Info Modal -->
<div class="modal fade" id="songInfoModal" tabindex="-1" aria-labelledby="songInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="songInfoModalLabel">Song Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Title:</strong></td><td id="modalSongTitle">-</td></tr>
                            <tr><td><strong>Artist:</strong></td><td id="modalSongArtist">-</td></tr>
                            <tr><td><strong>Album:</strong></td><td id="modalSongAlbum">-</td></tr>
                            <tr><td><strong>Track:</strong></td><td id="modalSongTrack">-</td></tr>
                            <tr><td><strong>Duration:</strong></td><td id="modalSongDuration">-</td></tr>
                            <tr><td><strong>Genre:</strong></td><td id="modalSongGenre">-</td></tr>
                            <tr><td><strong>Year:</strong></td><td id="modalSongYear">-</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Audio Features</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Energy:</strong></td><td id="modalSongEnergy">-</td></tr>
                            <tr><td><strong>Valence:</strong></td><td id="modalSongValence">-</td></tr>
                            <tr><td><strong>Danceability:</strong></td><td id="modalSongDanceability">-</td></tr>
                        </table>
                        <h6>Tags</h6>
                        <div id="modalSongTags" class="mb-3">-</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6>File Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>File Path:</strong></td><td id="modalSongPath" class="text-break">-</td></tr>
                            <tr><td><strong>File Size:</strong></td><td id="modalSongSize">-</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/static/js/playlist-player.js"></script>
<script src="/static/js/playlist-common.js"></script>


<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// Global variables (used by shared library)
let playlistId = null;
let playlist = null;
let songs = [];

document.addEventListener('DOMContentLoaded', function() {
    // Get playlist ID from URL
    const path = window.location.pathname;
    playlistId = parseInt(path.split('/').pop());
    
    // Initialize shared player
    window.playlistPlayer.init(playlistId);
    
    // Load playlist data
    loadPlaylistData();
    
    // Setup sortable for drag and drop
    setupSortable();
});

async function loadPlaylistData() {
    try {
        // Load unified playlist data with songs
        const response = await fetch(`/api/unified-playlists/${playlistId}/songs`);
        if (!response.ok) {
            throw new Error('Playlist not found');
        }
        
        const data = await response.json();
        playlist = data.playlist;
        songs = data.songs || [];
        
        // Update shared player data
        window.playlistPlayer.playlist = playlist;
        window.playlistPlayer.songs = songs;
        
        // Update UI
        window.playlistPlayer.updatePlaylistInfo();
        renderPlaylistSongs();
        window.playlistPlayer.updateStatistics();
        
        // Update statistics display
        updatePlaylistStatistics(data);
        
        // Render dynamic criteria
        renderDynamicCriteria();
        
        // Set edit button link
        document.getElementById('editPlaylistBtn').href = `/unified-playlists/edit/${playlistId}`;
        
    } catch (error) {
        console.error('Error loading playlist:', error);
        notificationSystem.error("Error", 'Error loading playlist. Returning to playlists page.');
        window.location.href = '/playlists';
    }
}

function renderPlaylistSongs() {
    const container = document.getElementById('playlistSongs');
    
    if (songs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-music fa-2x mb-2"></i>
                <p>No songs in this playlist</p>
            </div>
        `;
        return;
    }
    
    // Create table structure for better layout
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th width="30"></th>
                        <th width="30"></th>
                        <th width="200">Name</th>
                        <th width="150">Folder</th>
                        <th width="150">Album</th>
                        <th width="50">Info</th>
                    </tr>
                </thead>
                <tbody id="songTableBody">
                </tbody>
            </table>
        </div>
    `;

    const tbody = document.getElementById('songTableBody');
    tbody.innerHTML = songs.map((song, index) => {
        return `
            <tr class="song-item" data-song-id="${song.id}" data-index="${index}">
                <td>
                    <div class="drag-handle" style="cursor: grab;">
                        <i class="fas fa-grip-vertical text-muted"></i>
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="playSong(${index})" title="Play Song">
                        <i class="fas fa-play"></i>
                    </button>
                </td>
                <td class="fw-bold" title="${song.display_name}">${song.display_name}</td>
                <td class="text-muted" title="${window.playlistPlayer.getFolder(song.file_path)}">
                    <small>${window.playlistPlayer.getFolder(song.file_path) || '-'}</small>
                </td>
                <td class="text-muted" title="${song.album || ''}">
                    <small>${song.album || '-'}</small>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="showPlaylistSongInfo(${song.id})" title="Song Info">
                        <i class="fas fa-info"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function updatePlaylistStatistics(data) {
    // Add statistics display showing manual vs criteria-based song counts
    const playlistDescription = document.getElementById('playlistDescription');
    if (playlistDescription && data) {
        const originalText = playlist.description || 'No description';
        const statsText = `${originalText} • Total: ${data.total_count} songs (${data.manual_count} manual, ${data.dynamic_count} criteria-based)`;
        playlistDescription.textContent = statsText;
    }
}

function renderDynamicCriteria() {
    const criteriaSection = document.getElementById('dynamicCriteriaSection');
    const criteriaList = document.getElementById('dynamicCriteriaList');
    
    if (!playlist.dynamic_criteria || playlist.dynamic_criteria.length === 0) {
        criteriaSection.style.display = 'none';
        return;
    }
    
    criteriaSection.style.display = 'block';
    
    criteriaList.innerHTML = playlist.dynamic_criteria.map(criteria => {
        const includeCount = Object.keys(criteria.include_criteria || {}).length;
        const excludeCount = Object.keys(criteria.exclude_criteria || {}).length;
        
        return `
            <div class="border rounded p-3 mb-3 bg-light">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-2">
                            <i class="fas fa-filter me-2"></i>${criteria.name}
                        </h6>
                        <div class="small text-muted">
                            ${includeCount > 0 ? `<span class="badge bg-success me-1">+${includeCount} include</span>` : ''}
                            ${excludeCount > 0 ? `<span class="badge bg-danger me-1">-${excludeCount} exclude</span>` : ''}
                        </div>
                        <div class="mt-2">
                            ${renderCriteriaSummary(criteria)}
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editCriteria(${criteria.id})" title="Edit Criteria">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCriteria(${criteria.id})" title="Delete Criteria">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderCriteriaSummary(criteria) {
    const parts = [];
    
    // Include criteria
    if (criteria.include_criteria) {
        Object.entries(criteria.include_criteria).forEach(([field, values]) => {
            if (Array.isArray(values) && values.length > 0) {
                parts.push(`<span class="text-success">Include ${field}: ${values.slice(0, 3).join(', ')}${values.length > 3 ? '...' : ''}</span>`);
            } else if (values && typeof values === 'object' && (values.min !== undefined || values.max !== undefined)) {
                const range = [];
                if (values.min !== undefined) range.push(`min: ${values.min}`);
                if (values.max !== undefined) range.push(`max: ${values.max}`);
                parts.push(`<span class="text-success">Include ${field}: ${range.join(', ')}</span>`);
            }
        });
    }
    
    // Exclude criteria  
    if (criteria.exclude_criteria) {
        Object.entries(criteria.exclude_criteria).forEach(([field, values]) => {
            if (Array.isArray(values) && values.length > 0) {
                parts.push(`<span class="text-danger">Exclude ${field}: ${values.slice(0, 3).join(', ')}${values.length > 3 ? '...' : ''}</span>`);
            } else if (values && typeof values === 'object' && (values.min !== undefined || values.max !== undefined)) {
                const range = [];
                if (values.min !== undefined) range.push(`min: ${values.min}`);
                if (values.max !== undefined) range.push(`max: ${values.max}`);
                parts.push(`<span class="text-danger">Exclude ${field}: ${range.join(', ')}</span>`);
            }
        });
    }
    
    return parts.length > 0 ? `<div class="small">${parts.join('<br>')}</div>` : '<span class="text-muted small">No criteria defined</span>';
}

function addDynamicCriteria() {
    // TODO: Open modal or redirect to criteria editor
    notificationSystem.info("Coming Soon", "Smart criteria editing will be implemented next");
}

function editCriteria(criteriaId) {
    // TODO: Open modal or redirect to criteria editor
    notificationSystem.info("Coming Soon", "Dynamic criteria editing will be implemented next");
}

function deleteCriteria(criteriaId) {
    if (!confirm('Are you sure you want to delete this criteria?')) return;
    
    // TODO: Implement criteria deletion
    notificationSystem.info("Coming Soon", "Dynamic criteria deletion will be implemented next");
}

function setupSortable() {
    const container = document.getElementById('songTableBody');
    if (!container) return;
    
    new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        handle: '.drag-handle',
        onEnd: function(evt) {
            // Reorder songs array
            const movedSong = songs.splice(evt.oldIndex, 1)[0];
            songs.splice(evt.newIndex, 0, movedSong);
            
            // Update shared player data
            window.playlistPlayer.songs = songs;
            
            // Update backend with new order
            updateUnifiedPlaylistOrder();
            
            // Re-render to update indices
            renderPlaylistSongs();
        }
    });
}

async function updateUnifiedPlaylistOrder() {
    try {
        const songIds = songs.map(song => song.id);
        const response = await fetch(`/api/unified-playlists/${playlistId}/reorder`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ song_order: songIds })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update playlist order');
        }
    } catch (error) {
        console.error('Error updating playlist order:', error);
        notificationSystem.error("Error", 'Failed to update song order');
    }
}
</script>

<style>
.sortable-ghost {
    opacity: 0.5;
}

.sortable-chosen {
    background-color: #f8f9fa;
}

.sortable-drag {
    background-color: #ffffff;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.song-item:hover {
    background-color: #f8f9fa;
}

.song-item.bg-primary:hover {
    background-color: #0d6efd !important;
}

.drag-handle:active {
    cursor: grabbing;
}
</style>
{% endblock %}
