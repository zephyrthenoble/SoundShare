{% extends "base.html" %}

{% block title %}Dynamic Criteria Management - SoundShare{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Dynamic Criteria Management</h1>
        <button type="button" class="btn btn-primary" onclick="clearForm()">
            <i class="fas fa-plus"></i> New Criteria
        </button>
    </div>

    <!-- Criteria List -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Existing Criteria</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="criteriaTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Include Criteria</th>
                                    <th>Exclude Criteria</th>
                                    <th>Used in Playlists</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="criteriaTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Criteria Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0" id="formTitle">Create New Criteria</h5>
                </div>
                <div class="card-body">
                    <form id="criteriaForm">
                        <input type="hidden" id="criteriaId" value="">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="criteriaName" class="form-label">Criteria Name *</label>
                                <input type="text" class="form-control" id="criteriaName" required>
                                <div class="form-text">Must be unique. Changing the name will create a new criteria.</div>
                            </div>
                        </div>

                        <!-- Song Search Component for Criteria Building -->
                        <div id="songSearchContainer">
                            <div class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Loading song search component...
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-success" id="saveBtn">
                                    <i class="fas fa-save"></i> Save Criteria
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" onclick="clearForm()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this criteria?</p>
                <p><strong id="deleteItemName"></strong></p>
                <div id="playlistWarning" class="alert alert-warning d-none">
                    <i class="fas fa-exclamation-triangle"></i>
                    This criteria is used in <span id="playlistCount"></span> playlist(s). Deleting it will remove it from those playlists.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/song-search-component.js"></script>
<script>
let criteriaSearchComponent;
let currentCriteria = null;
let allCriteria = [];

document.addEventListener('DOMContentLoaded', function() {
    // Add a delay to ensure all scripts are loaded
    setTimeout(() => {
        initializePage();
    }, 250);
});

async function initializePage() {
    try {
        console.log('Initializing criteria page...');
        console.log('SongSearchComponent available:', typeof SongSearchComponent);
        
        // Initialize the song search component for criteria building
        criteriaSearchComponent = new SongSearchComponent({
            containerSelector: '#songSearchContainer',
            showBulkActions: false
        });
        
        console.log('Song search component created:', criteriaSearchComponent);
        
        // Wait a moment for the component to initialize, then load criteria
        setTimeout(async () => {
            console.log('Loading criteria...');
            await loadCriteria();
        }, 500);
        
        // Setup form submission
        document.getElementById('criteriaForm').addEventListener('submit', saveCriteria);
        
        console.log('Page initialization complete');
        
    } catch (error) {
        console.error('Failed to initialize criteria page:', error);
        notificationSystem.error('Error', 'Failed to initialize page');
    }
}

async function loadCriteria() {
    try {
        const response = await fetch('/criteria/api');
        if (!response.ok) throw new Error('Failed to fetch criteria');
        
        allCriteria = await response.json();
        renderCriteriaTable();
    } catch (error) {
        console.error('Failed to load criteria:', error);
        notificationSystem.error('Error', 'Failed to load criteria');
    }
}

function renderCriteriaTable() {
    const tbody = document.getElementById('criteriaTableBody');
    tbody.innerHTML = '';
    
    allCriteria.forEach(criteria => {
        const row = document.createElement('tr');
        
        // Format criteria display
        const includeDisplay = formatCriteriaDisplay(criteria.include_criteria);
        const excludeDisplay = formatCriteriaDisplay(criteria.exclude_criteria);
        
        row.innerHTML = `
            <td><strong>${escapeHtml(criteria.name)}</strong></td>
            <td>${includeDisplay}</td>
            <td>${excludeDisplay}</td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="showPlaylistUsage(${criteria.id})">
                    <i class="fas fa-list"></i> View Usage
                </button>
            </td>
            <td>${new Date(criteria.created_at).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editCriteria(${criteria.id})">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteCriteria(${criteria.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function formatCriteriaDisplay(criteria) {
    if (!criteria || Object.keys(criteria).length === 0) {
        return '<em class="text-muted">None</em>';
    }
    
    const parts = [];
    
    if (criteria.tags && criteria.tags.length > 0) {
        parts.push(`Tags: ${criteria.tags.length}`);
    }
    if (criteria.tag_groups && criteria.tag_groups.length > 0) {
        parts.push(`Tag Groups: ${criteria.tag_groups.length}`);
    }
    if (criteria.artists && criteria.artists.length > 0) {
        parts.push(`Artists: ${criteria.artists.length}`);
    }
    if (criteria.albums && criteria.albums.length > 0) {
        parts.push(`Albums: ${criteria.albums.length}`);
    }
    if (criteria.genres && criteria.genres.length > 0) {
        parts.push(`Genres: ${criteria.genres.length}`);
    }
    if (criteria.folders && criteria.folders.length > 0) {
        parts.push(`Folders: ${criteria.folders.length}`);
    }
    if (criteria.energy) {
        parts.push(`Energy: ${criteria.energy.min}-${criteria.energy.max}`);
    }
    if (criteria.valence) {
        parts.push(`Valence: ${criteria.valence.min}-${criteria.valence.max}`);
    }
    if (criteria.danceability) {
        parts.push(`Danceability: ${criteria.danceability.min}-${criteria.danceability.max}`);
    }
    if (criteria.tempo) {
        parts.push(`Tempo: ${criteria.tempo.min}-${criteria.tempo.max}`);
    }
    if (criteria.duration) {
        parts.push(`Duration: ${criteria.duration.min}-${criteria.duration.max}s`);
    }
    if (criteria.year) {
        parts.push(`Year: ${criteria.year.min}-${criteria.year.max}`);
    }
    
    return parts.length > 0 ? parts.join('<br>') : '<em class="text-muted">None</em>';
}

function editCriteria(criteriaId) {
    const criteria = allCriteria.find(c => c.id === criteriaId);
    if (!criteria) return;
    
    currentCriteria = criteria;
    
    // Fill form
    document.getElementById('criteriaId').value = criteria.id;
    document.getElementById('criteriaName').value = criteria.name;
    document.getElementById('formTitle').textContent = 'Edit Criteria';
    document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Update Criteria';
    
    // Load criteria into song search component
    criteriaSearchComponent.loadCriteria(criteria.include_criteria, criteria.exclude_criteria);
    
    // Scroll to form
    document.getElementById('criteriaForm').scrollIntoView({ behavior: 'smooth' });
}

function clearForm() {
    currentCriteria = null;
    document.getElementById('criteriaForm').reset();
    document.getElementById('criteriaId').value = '';
    document.getElementById('formTitle').textContent = 'Create New Criteria';
    document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Save Criteria';
    
    // Clear search component
    criteriaSearchComponent.clearFilters();
}

async function saveCriteria(event) {
    event.preventDefault();
    
    const criteriaId = document.getElementById('criteriaId').value;
    const name = document.getElementById('criteriaName').value.trim();
    
    if (!name) {
        notificationSystem.error('Error', 'Criteria name is required');
        return;
    }
    
    try {
        // Get criteria from search component
        const { includeCriteria, excludeCriteria } = criteriaSearchComponent.getCriteria();
        
        const data = {
            name: name,
            include_criteria: includeCriteria,
            exclude_criteria: excludeCriteria
        };
        
        let response;
        if (criteriaId) {
            // Update existing
            response = await fetch(`/criteria/api/${criteriaId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } else {
            // Create new
            response = await fetch('/criteria/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to save criteria');
        }
        
        notificationSystem.success('Success', criteriaId ? 'Criteria updated successfully' : 'Criteria created successfully');
        await loadCriteria();
        clearForm();
        
    } catch (error) {
        console.error('Failed to save criteria:', error);
        notificationSystem.error('Error', error.message);
    }
}

async function deleteCriteria(criteriaId) {
    const criteria = allCriteria.find(c => c.id === criteriaId);
    if (!criteria) return;
    
    try {
        // Check playlist usage
        const response = await fetch(`/criteria/api/${criteriaId}/playlists`);
        const playlists = await response.json();
        
        // Show confirmation modal
        document.getElementById('deleteItemName').textContent = criteria.name;
        
        if (playlists.length > 0) {
            document.getElementById('playlistWarning').classList.remove('d-none');
            document.getElementById('playlistCount').textContent = playlists.length;
        } else {
            document.getElementById('playlistWarning').classList.add('d-none');
        }
        
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
        
        // Setup delete confirmation
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            try {
                const deleteResponse = await fetch(`/criteria/api/${criteriaId}`, {
                    method: 'DELETE'
                });
                
                if (!deleteResponse.ok) throw new Error('Failed to delete criteria');
                
                notificationSystem.success('Success', 'Criteria deleted successfully');
                await loadCriteria();
                modal.hide();
                
            } catch (error) {
                console.error('Failed to delete criteria:', error);
                notificationSystem.error('Error', 'Failed to delete criteria');
            }
        };
        
    } catch (error) {
        console.error('Failed to check criteria usage:', error);
        notificationSystem.error('Error', 'Failed to check criteria usage');
    }
}

async function showPlaylistUsage(criteriaId) {
    try {
        const response = await fetch(`/criteria/api/${criteriaId}/playlists`);
        const playlists = await response.json();
        
        if (playlists.length === 0) {
            notificationSystem.info('Info', 'This criteria is not used in any playlists');
            return;
        }
        
        const playlistNames = playlists.map(p => p.name).join('<br>');
        notificationSystem.info('Playlist Usage', `This criteria is used in:<br>${playlistNames}`);
        
    } catch (error) {
        console.error('Failed to load playlist usage:', error);
        notificationSystem.error('Error', 'Failed to load playlist usage');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Make functions globally accessible
window.clearForm = clearForm;
window.editCriteria = editCriteria;
window.deleteCriteria = deleteCriteria;
window.showPlaylistUsage = showPlaylistUsage;
</script>
{% endblock %}
