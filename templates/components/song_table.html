<!-- Reusable Song Table Component -->
<!-- Usage: Include this file and call songTable.init(config) -->

<div class="song-table-component" id="songTableComponent">
    <!-- Song Table -->
    <div class="card w-100">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped song-table mb-0" id="songsTable">
                    <thead>
                        <tr class="table-header-row">
                            <!-- Headers will be dynamically generated -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Songs will be loaded here via JavaScript -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                <div class="pagination-info">
                    <small class="text-muted">
                        Showing <span id="paginationStart-songsTable">1</span>-<span id="paginationEnd-songsTable">25</span> of <span id="paginationTotal-songsTable">0</span> songs
                    </small>
                </div>
                <nav aria-label="Table pagination">
                    <ul class="pagination pagination-sm mb-0" id="paginationControls-songsTable">
                        <!-- Pagination buttons will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<style>
/* Song Table Component Styles */
.song-table-component .table {
    table-layout: fixed;
    width: 100%;
}

.song-table-component .table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
}

.song-table-component .table td {
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Column minimum widths based on header text length */
.song-table-component .col-checkbox { min-width: 50px; }
.song-table-component .col-name { min-width: 60px; }
.song-table-component .col-tags { min-width: 50px; }
.song-table-component .col-artist { min-width: 60px; }
.song-table-component .col-album { min-width: 60px; }
.song-table-component .col-folder { min-width: 60px; }
.song-table-component .col-duration { min-width: 70px; }
.song-table-component .col-tempo { min-width: 65px; }
.song-table-component .col-created-at { min-width: 85px; }
.song-table-component .col-mood { min-width: 55px; }

.song-table-component .table tbody tr {
    cursor: pointer;
    transition: background-color 0.15s ease;
}

.song-table-component .table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.075);
}

.song-table-component .table tbody tr.table-secondary {
    background-color: #e2e3e5;
}

.song-table-component .song-preview-row {
    background-color: #f8f9fa !important;
}

.song-table-component .song-preview-row:hover {
    background-color: #f8f9fa !important;
}

/* Mood/Audio Features Bars */
.song-table-component .mood-bars {
    height: 32px !important;
    min-height: 32px !important;
    display: flex !important;
    flex-direction: column !important;
}

.song-table-component .mood-bar-container {
    height: 8px !important;
    min-height: 8px !important;
    background-color: #e9ecef;
    margin-bottom: 2px;
    border-radius: 4px;
    overflow: hidden;
}

.song-table-component .mood-bar-container:last-child {
    margin-bottom: 0;
}

.song-table-component .energy-bar {
    background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%);
    height: 8px !important;
    min-height: 8px !important;
    transition: width 0.3s ease;
}

.song-table-component .valence-bar {
    background: linear-gradient(90deg, #6f42c1 0%, #0d6efd 100%);
    height: 8px !important;
    min-height: 8px !important;
    transition: width 0.3s ease;
}

.song-table-component .danceability-bar {
    background: linear-gradient(90deg, #198754 0%, #20c997 100%);
    height: 8px !important;
    min-height: 8px !important;
    transition: width 0.3s ease;
}

/* Text overflow handling */
.song-table-component .text-ellipsis {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Audio player styles */
.song-table-component audio {
    width: 100%;
    height: 32px;
}

.song-table-component .segment-btn {
    flex: 1;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.song-table-component .segment-label {
    font-size: 0.7rem;
    line-height: 1;
}

/* Tags display */
.song-table-component .tag-badge {
    font-size: 0.7rem;
    margin-right: 0.25rem;
    margin-bottom: 0.25rem;
}

/* Pagination styles */
.song-table-component .pagination-info {
    color: #6c757d;
}

.song-table-component .pagination .page-link {
    color: #495057;
    border-color: #dee2e6;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.song-table-component .pagination .page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.song-table-component .pagination .page-link:hover {
    color: #0d6efd;
    background-color: #e9ecef;
    border-color: #dee2e6;
}

.song-table-component .table-responsive {
    border-radius: 0.375rem 0.375rem 0 0;
}
</style>

<script>
// Song Table Component JavaScript
window.songTable = (function() {
    // Private variables for each table instance
    const instances = new Map();
    
    // Initialize a song table instance
    function init(config) {
        const tableId = config.tableId || 'songsTable';
        const instance = {
            tableId: tableId,
            songs: [],
            filteredSongs: [],
            selectedSongs: new Set(),
            lastSelectedIndex: null,
            expandedSongId: null,
            expandedSongRow: null,
            currentSortField: config.defaultSort || 'display_name',
            currentSortDirection: 'asc',
            currentPage: 1,
            itemsPerPage: 25,
            config: config,
            onSelectionChange: config.onSelectionChange || function() {},
            onSongClick: config.onSongClick || function() {},
            onEditSong: config.onEditSong || function() {},
            onManageTags: config.onManageTags || function() {}
        };
        
        instances.set(tableId, instance);
        
        // Set the table ID
        const table = document.querySelector('.song-table');
        if (table) {
            table.id = tableId;
        }
        
        // Generate table headers
        generateTableHeaders(tableId);
        
        return instance;
    }
    
    // Generate table headers based on configuration
    function generateTableHeaders(tableId) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        const headerRow = document.querySelector(`#${tableId} .table-header-row`);
        if (!headerRow) return;
        
        let headersHTML = '';
        
        // Checkbox column
        if (instance.config.showCheckboxes) {
            headersHTML += `
                <th class="col-checkbox" style="width: 3%;">
                    <input type="checkbox" class="select-all-checkbox" onchange="songTable.toggleSelectAll('${tableId}')">
                </th>
            `;
        }
        
        // Name column (always shown) - Large share
        headersHTML += `
            <th class="col-name" style="width: 25%; cursor: pointer;" onclick="songTable.sortTable('${tableId}', 'display_name')">
                Name <i class="fas fa-sort" id="sort-display_name-${tableId}"></i>
            </th>
        `;
        
        // Tags column (moved to be between Name and Artist) - Large share
        if (instance.config.showTags) {
            headersHTML += `
                <th class="col-tags" style="width: 20%;">Tags</th>
            `;
        }
        
        // Artist column (always shown) - Medium share
        headersHTML += `
            <th class="col-artist" style="width: 15%; cursor: pointer;" onclick="songTable.sortTable('${tableId}', 'artist')">
                Artist <i class="fas fa-sort" id="sort-artist-${tableId}"></i>
            </th>
        `;
        
        // Album column (always shown) - Large share
        headersHTML += `
            <th class="col-album" style="width: 20%; cursor: pointer;" onclick="songTable.sortTable('${tableId}', 'album')">
                Album <i class="fas fa-sort" id="sort-album-${tableId}"></i>
            </th>
        `;
        
        // Folder column - Large share
        if (instance.config.showFolder) {
            headersHTML += `
                <th class="col-folder" style="width: 15%; cursor: pointer;" onclick="songTable.sortTable('${tableId}', 'folder')">
                    Folder <i class="fas fa-sort" id="sort-folder-${tableId}"></i>
                </th>
            `;
        }
        
        // Duration column (always shown) - Small share
        headersHTML += `
            <th class="col-duration" style="width: 6%; cursor: pointer;" onclick="songTable.sortTable('${tableId}', 'duration')">
                Duration <i class="fas fa-sort" id="sort-duration-${tableId}"></i>
            </th>
        `;
        
        // Tempo column - Small share
        if (instance.config.showAudioFeatures) {
            headersHTML += `
                <th class="col-tempo" style="width: 6%; cursor: pointer;" onclick="songTable.sortTable('${tableId}', 'tempo')">
                    Tempo <i class="fas fa-sort" id="sort-tempo-${tableId}"></i>
                </th>
            `;
        }
        
        // Created At column - Small share
        if (instance.config.showCreatedAt) {
            headersHTML += `
                <th class="col-created-at" style="width: 8%; cursor: pointer; font-size: 0.875rem;" onclick="songTable.sortTable('${tableId}', 'created_at')">
                    Created At <i class="fas fa-sort" id="sort-created_at-${tableId}"></i>
                </th>
            `;
        }
        
        // Audio Features column (Mood bars) - Small share
        if (instance.config.showAudioFeatures) {
            headersHTML += `
                <th class="col-mood" style="width: 6%;">Mood</th>
            `;
        }
        
        // Tags column (removed from here since it was moved up)
        
        headerRow.innerHTML = headersHTML;
    }
    
    // Set songs data for a table instance
    function setSongs(tableId, songs) {
        const instance = instances.get(tableId);
        if (instance) {
            instance.songs = songs;
            instance.filteredSongs = [...songs];
            renderTable(tableId);
        }
    }
    
    // Filter songs for a table instance
    function filterSongs(tableId, filterFn) {
        const instance = instances.get(tableId);
        if (instance) {
            instance.filteredSongs = instance.songs.filter(filterFn);
            instance.currentPage = 1; // Reset to first page when filtering
            renderTable(tableId);
        }
    }
    
    // Render the table
    function renderTable(tableId) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        const tbody = document.querySelector(`#${tableId} tbody`);
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        // Calculate pagination
        const totalSongs = instance.filteredSongs.length;
        const totalPages = Math.ceil(totalSongs / instance.itemsPerPage);
        const startIndex = (instance.currentPage - 1) * instance.itemsPerPage;
        const endIndex = Math.min(startIndex + instance.itemsPerPage, totalSongs);
        
        // Get songs for current page
        const pageSongs = instance.filteredSongs.slice(startIndex, endIndex);
        
        pageSongs.forEach((song, index) => {
            const row = document.createElement('tr');
            row.dataset.songId = song.id;
            row.style.cursor = 'pointer';
            
            const isSelected = instance.selectedSongs.has(song.id);
            
            // Build row HTML based on configuration
            let rowHTML = '';
            
            // Checkbox column
            if (instance.config.showCheckboxes) {
                rowHTML += `
                    <td class="col-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" class="song-checkbox" data-song-id="${song.id}" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="songTable.toggleSongSelection('${tableId}', ${song.id}, event)"
                               onclick="event.shiftKey && songTable.handleShiftClick('${tableId}', ${song.id}, event)">
                    </td>
                `;
            }
            
            // Name column
            rowHTML += `
                <td class="col-name text-ellipsis" title="${song.display_name}">
                    ${song.display_name}
                </td>
            `;
            
            // Tags column (moved to be between Name and Artist)
            if (instance.config.showTags) {
                const tagsHTML = song.tags && song.tags.length > 0 ? 
                    song.tags.map(tag => `<span class="badge bg-secondary tag-badge">${tag.name}</span>`).join('') : 
                    '<span class="text-muted small">No tags</span>';
                
                rowHTML += `
                    <td class="col-tags">
                        <div class="d-flex flex-wrap">
                            ${tagsHTML}
                        </div>
                    </td>
                `;
            }
            
            // Artist column
            rowHTML += `
                <td class="col-artist text-ellipsis" title="${song.artist || ''}">
                    ${song.artist || ''}
                </td>
            `;
            
            // Album column
            rowHTML += `
                <td class="col-album text-ellipsis" title="${song.album || ''}">
                    ${song.album || ''}
                </td>
            `;
            
            // Folder column
            if (instance.config.showFolder) {
                const folder = song.folder;
                rowHTML += `
                    <td class="col-folder text-ellipsis" title="${folder}">
                        <small class="text-muted">${folder}</small>
                    </td>
                `;
            }
            
            // Duration column
            rowHTML += `
                <td class="col-duration"><small>${formatDuration(song.duration)}</small></td>
            `;
            
            // Tempo column
            if (instance.config.showAudioFeatures) {
                rowHTML += `
                    <td class="col-tempo"><small>${song.tempo ? Math.round(song.tempo) + ' BPM' : ''}</small></td>
                `;
            }
            
            // Created At column
            if (instance.config.showCreatedAt) {
                rowHTML += `
                    <td class="col-created-at" style="font-size: 0.75rem;"><small>${formatDateTime(song.created_at)}</small></td>
                `;
            }
            
            // Audio Features column (Mood bars)
            if (instance.config.showAudioFeatures) {
                const energy = song.energy !== null && song.energy !== undefined ? Math.max((song.energy * 100).toFixed(0), 2) : '0';
                const valence = song.valence !== null && song.valence !== undefined ? Math.max((song.valence * 100).toFixed(0), 2) : '0';
                const danceability = song.danceability !== null && song.danceability !== undefined ? Math.max((song.danceability * 100).toFixed(0), 2) : '0';
                
                rowHTML += `
                    <td class="col-mood" style="padding: 4px; height: 40px; vertical-align: middle;">
                        <div class="mood-bars" style="width: 100%;" title="Energy: ${energy}% | Valence: ${valence}% | Danceability: ${danceability}%">
                            <div class="mood-bar-container">
                                <div class="energy-bar" style="width: ${energy}%;" title="Energy: ${energy}%"></div>
                            </div>
                            <div class="mood-bar-container">
                                <div class="valence-bar" style="width: ${valence}%;" title="Valence: ${valence}%"></div>
                            </div>
                            <div class="mood-bar-container">
                                <div class="danceability-bar" style="width: ${danceability}%;" title="Danceability: ${danceability}%"></div>
                            </div>
                        </div>
                    </td>
                `;
            }
            
            row.innerHTML = rowHTML;
            
            // Add click event to row
            row.addEventListener('click', (e) => {
                if (!e.target.closest('input[type="checkbox"]')) {
                    previewSong(tableId, song.id, row);
                    instance.onSongClick(song, row);
                }
            });
            
            tbody.appendChild(row);
        });
        
        updateSortIndicators(tableId);
        updatePaginationInfo(tableId);
        renderPaginationControls(tableId);
    }
    
    // Update pagination info display
    function updatePaginationInfo(tableId) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        const totalSongs = instance.filteredSongs.length;
        const startIndex = (instance.currentPage - 1) * instance.itemsPerPage;
        const endIndex = Math.min(startIndex + instance.itemsPerPage, totalSongs);
        
        const startSpan = document.getElementById(`paginationStart-${tableId}`);
        const endSpan = document.getElementById(`paginationEnd-${tableId}`);
        const totalSpan = document.getElementById(`paginationTotal-${tableId}`);
        
        if (startSpan) startSpan.textContent = totalSongs > 0 ? startIndex + 1 : 0;
        if (endSpan) endSpan.textContent = endIndex;
        if (totalSpan) totalSpan.textContent = totalSongs;
    }
    
    // Render pagination controls
    function renderPaginationControls(tableId) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        const totalSongs = instance.filteredSongs.length;
        const totalPages = Math.ceil(totalSongs / instance.itemsPerPage);
        const currentPage = instance.currentPage;
        
        const paginationControls = document.getElementById(`paginationControls-${tableId}`);
        if (!paginationControls) return;
        
        paginationControls.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `
            <a class="page-link" href="#" onclick="songTable.goToPage('${tableId}', ${currentPage - 1}); return false;">
                <i class="fas fa-chevron-left"></i>
            </a>
        `;
        paginationControls.appendChild(prevLi);
        
        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // First page link if needed
        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = `
                <a class="page-link" href="#" onclick="songTable.goToPage('${tableId}', 1); return false;">1</a>
            `;
            paginationControls.appendChild(firstLi);
            
            if (startPage > 2) {
                const dotsLi = document.createElement('li');
                dotsLi.className = 'page-item disabled';
                dotsLi.innerHTML = '<span class="page-link">...</span>';
                paginationControls.appendChild(dotsLi);
            }
        }
        
        // Page number links
        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `
                <a class="page-link" href="#" onclick="songTable.goToPage('${tableId}', ${i}); return false;">${i}</a>
            `;
            paginationControls.appendChild(pageLi);
        }
        
        // Last page link if needed
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const dotsLi = document.createElement('li');
                dotsLi.className = 'page-item disabled';
                dotsLi.innerHTML = '<span class="page-link">...</span>';
                paginationControls.appendChild(dotsLi);
            }
            
            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `
                <a class="page-link" href="#" onclick="songTable.goToPage('${tableId}', ${totalPages}); return false;">${totalPages}</a>
            `;
            paginationControls.appendChild(lastLi);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `
            <a class="page-link" href="#" onclick="songTable.goToPage('${tableId}', ${currentPage + 1}); return false;">
                <i class="fas fa-chevron-right"></i>
            </a>
        `;
        paginationControls.appendChild(nextLi);
    }
    
    // Go to specific page
    function goToPage(tableId, page) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        const totalPages = Math.ceil(instance.filteredSongs.length / instance.itemsPerPage);
        
        if (page < 1 || page > totalPages) return;
        
        instance.currentPage = page;
        renderTable(tableId);
    }
    
    // Toggle song selection with shift-click support
    function toggleSongSelection(tableId, songId, event = null) {
        const instance = instances.get(tableId);
        if (!instance) return;

        // Handle shift-click for range selection
        if (event && event.shiftKey && instance.lastSelectedIndex !== null) {
            handleShiftClick(tableId, songId, event);
            return;
        }

        // Store this as the last selected for future shift-clicks
        const currentIndex = instance.filteredSongs.findIndex(song => song.id === songId);
        instance.lastSelectedIndex = currentIndex;

        if (instance.selectedSongs.has(songId)) {
            instance.selectedSongs.delete(songId);
        } else {
            instance.selectedSongs.add(songId);
        }

        updateSelectAllCheckbox(tableId);
        instance.onSelectionChange(Array.from(instance.selectedSongs));
    }

    // Handle shift-click for range selection
    function handleShiftClick(tableId, songId, event) {
        const instance = instances.get(tableId);
        if (!instance || instance.lastSelectedIndex === null) return;

        event.preventDefault();
        
        const currentIndex = instance.filteredSongs.findIndex(song => song.id === songId);
        const startIndex = Math.min(instance.lastSelectedIndex, currentIndex);
        const endIndex = Math.max(instance.lastSelectedIndex, currentIndex);

        // Determine if we should select or deselect the range
        // If the clicked item is currently selected, we'll deselect the range
        const shouldSelect = !instance.selectedSongs.has(songId);

        // Select/deselect all songs in the range
        for (let i = startIndex; i <= endIndex; i++) {
            const song = instance.filteredSongs[i];
            if (song) {
                if (shouldSelect) {
                    instance.selectedSongs.add(song.id);
                } else {
                    instance.selectedSongs.delete(song.id);
                }
            }
        }

        // Update checkboxes
        const checkboxes = document.querySelectorAll(`#${tableId} .song-checkbox`);
        checkboxes.forEach(checkbox => {
            const checkboxSongId = parseInt(checkbox.dataset.songId);
            checkbox.checked = instance.selectedSongs.has(checkboxSongId);
        });

        updateSelectAllCheckbox(tableId);
        instance.onSelectionChange(Array.from(instance.selectedSongs));
    }
    
    // Toggle select all
    function toggleSelectAll(tableId) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        const selectAllCheckbox = document.querySelector(`#${tableId} .select-all-checkbox`);
        const isChecked = selectAllCheckbox.checked;
        
        if (isChecked) {
            // Select all visible songs
            instance.filteredSongs.forEach(song => {
                instance.selectedSongs.add(song.id);
            });
        } else {
            // Deselect all songs
            instance.selectedSongs.clear();
        }
        
        // Update individual checkboxes
        const checkboxes = document.querySelectorAll(`#${tableId} .song-checkbox`);
        checkboxes.forEach(checkbox => {
            const songId = parseInt(checkbox.dataset.songId);
            checkbox.checked = instance.selectedSongs.has(songId);
        });
        
        instance.onSelectionChange(Array.from(instance.selectedSongs));
    }
    
    // Update select all checkbox state
    function updateSelectAllCheckbox(tableId) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        const selectAllCheckbox = document.querySelector(`#${tableId} .select-all-checkbox`);
        if (!selectAllCheckbox) return;
        
        const visibleSongIds = instance.filteredSongs.map(s => s.id);
        const selectedVisibleCount = visibleSongIds.filter(id => instance.selectedSongs.has(id)).length;
        
        selectAllCheckbox.indeterminate = selectedVisibleCount > 0 && selectedVisibleCount < visibleSongIds.length;
        selectAllCheckbox.checked = selectedVisibleCount > 0 && selectedVisibleCount === visibleSongIds.length;
    }
    
    // Sort table
    function sortTable(tableId, field) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        if (instance.currentSortField === field) {
            instance.currentSortDirection = instance.currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            instance.currentSortField = field;
            instance.currentSortDirection = 'asc';
        }
        
        instance.filteredSongs.sort((a, b) => {
            let aVal = a[field] || '';
            let bVal = b[field] || '';
            
            // Handle special cases
            if (field === 'duration' || field === 'tempo') {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            } else if (field === 'created_at') {
                aVal = new Date(aVal).getTime() || 0;
                bVal = new Date(bVal).getTime() || 0;
            } else {
                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();
            }
            
            if (aVal < bVal) return instance.currentSortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return instance.currentSortDirection === 'asc' ? 1 : -1;
            return 0;
        });
        
        renderTable(tableId);
    }
    
    // Update sort indicators
    function updateSortIndicators(tableId) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        // Reset all sort indicators
        const sortIcons = document.querySelectorAll(`#${tableId} [id^="sort-"]`);
        sortIcons.forEach(icon => {
            icon.className = 'fas fa-sort';
        });
        
        // Set current sort indicator
        const currentIcon = document.getElementById(`sort-${instance.currentSortField}-${tableId}`);
        if (currentIcon) {
            currentIcon.className = instance.currentSortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
        }
    }
    
    // Preview song functionality
    function previewSong(tableId, songId, rowElement) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        // Check if clicking on the already expanded row
        if (instance.expandedSongId === songId) {
            closePreview(tableId);
            return;
        }
        
        // Close any existing preview
        closePreview(tableId);
        
        // Set new expanded state
        instance.expandedSongId = songId;
        instance.expandedSongRow = rowElement;
        
        // Highlight the current row
        if (rowElement) {
            rowElement.classList.add('table-secondary');
        }
        
        // Get song data
        const song = instance.filteredSongs.find(s => s.id === songId);
        if (!song) {
            console.error('Song not found');
            return;
        }
        
        // Create preview row
        const previewRow = createPreviewRow(tableId, song);
        
        // Insert preview row after the current row
        rowElement.parentNode.insertBefore(previewRow, rowElement.nextSibling);
        
        // Setup audio player
        setupAudioPlayer(tableId, songId);
    }
    
    // Close preview
    function closePreview(tableId) {
        const instance = instances.get(tableId);
        if (!instance) return;
        
        // Stop all audio
        stopAllAudio(tableId);
        
        // Remove preview rows
        const existingPreviews = document.querySelectorAll(`#${tableId} .song-preview-row`);
        existingPreviews.forEach(preview => {
            const audioElements = preview.querySelectorAll('audio');
            audioElements.forEach(audio => {
                audio.pause();
                audio.src = '';
            });
            preview.remove();
        });
        
        // Remove highlighting
        if (instance.expandedSongRow) {
            instance.expandedSongRow.classList.remove('table-secondary');
        }
        
        // Reset state
        instance.expandedSongId = null;
        instance.expandedSongRow = null;
    }
    
    // Create preview row
    function createPreviewRow(tableId, song) {
        const instance = instances.get(tableId);
        const columnCount = getColumnCount(instance.config);
        
        const previewRow = document.createElement('tr');
        previewRow.className = 'song-preview-row';
        previewRow.innerHTML = `
            <td colspan="${columnCount}">
                <div class="card border-0 bg-light">
                    <div class="card-body py-3">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">${song.display_name}</h6>
                                    ${instance.config.showEditButton ? `
                                        <button class="btn btn-sm btn-outline-secondary" onclick="songTable.editSong('${tableId}', ${song.id}); event.stopPropagation();">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="text-muted small mb-2">
                                            <div><strong>Artist:</strong> ${song.artist || 'Unknown'}</div>
                                            <div><strong>Album:</strong> ${song.album || 'Unknown'}</div>
                                            <div><strong>Year:</strong> ${song.year || 'Unknown'}</div>
                                            <div><strong>Duration:</strong> ${formatDuration(song.duration)}</div>
                                            ${song.tempo ? `<div><strong>Tempo:</strong> ${Math.round(song.tempo)} BPM</div>` : ''}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted small mb-2">
                                            ${song.key ? `<div><strong>Key:</strong> ${song.key}</div>` : ''}
                                            ${song.file_size ? `<div><strong>File Size:</strong> ${Math.round(song.file_size / 1024)} KB</div>` : ''}
                                            ${song.energy !== null && song.energy !== undefined ? `<div><strong>Energy:</strong> ${Math.round(song.energy * 100)}%</div>` : ''}
                                            ${song.valence !== null && song.valence !== undefined ? `<div><strong>Valence:</strong> ${Math.round(song.valence * 100)}%</div>` : ''}
                                            ${song.danceability !== null && song.danceability !== undefined ? `<div><strong>Danceability:</strong> ${Math.round(song.danceability * 100)}%</div>` : ''}
                                        </div>
                                    </div>
                                </div>
                                ${instance.config.showTags && song.tags ? `
                                    <div class="mt-2">
                                        <div class="d-flex align-items-center mb-2">
                                            <strong class="me-2 small">Tags:</strong>
                                            ${instance.config.showTagManagement ? `
                                                <button class="btn btn-sm btn-outline-success" onclick="songTable.manageTags('${tableId}', ${song.id}); event.stopPropagation();" title="Add/Remove Tags">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div class="d-flex flex-wrap gap-1">
                                            ${song.tags && song.tags.length > 0 ? 
                                                song.tags.map(tag => `<span class="badge bg-secondary">${tag.name}</span>`).join('') : 
                                                '<span class="text-muted small">No tags assigned</span>'
                                            }
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <small class="text-muted">Song Preview</small>
                                </div>
                                <div class="mb-3">
                                    <audio id="previewPlayer-${tableId}-${song.id}" controls class="w-100"></audio>
                                </div>
                                <div class="mb-2" id="previewControls-${tableId}-${song.id}" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted">Preview Mode</small>
                                        <button id="autoPlayToggle-${tableId}-${song.id}" class="btn btn-sm btn-danger" onclick="songTable.toggleAutoPlay('${tableId}', ${song.id})">
                                            Stop Auto
                                        </button>
                                    </div>
                                    <div class="mb-2" id="segmentBar-${tableId}-${song.id}">
                                        <small class="text-muted">Preview Segments</small>
                                        <div class="btn-group w-100 mb-2" role="group">
                                            <button class="btn btn-outline-primary segment-btn" data-segment="0" onclick="songTable.playSegment('${tableId}', ${song.id}, 0)">
                                                <div class="segment-label">Start</div>
                                            </button>
                                            <button class="btn btn-outline-primary segment-btn" data-segment="1" onclick="songTable.playSegment('${tableId}', ${song.id}, 1)">
                                                <div class="segment-label">Pre-Mid</div>
                                            </button>
                                            <button class="btn btn-outline-primary segment-btn" data-segment="2" onclick="songTable.playSegment('${tableId}', ${song.id}, 2)">
                                                <div class="segment-label">Middle</div>
                                            </button>
                                            <button class="btn btn-outline-primary segment-btn" data-segment="3" onclick="songTable.playSegment('${tableId}', ${song.id}, 3)">
                                                <div class="segment-label">Post-Mid</div>
                                            </button>
                                            <button class="btn btn-outline-primary segment-btn" data-segment="4" onclick="songTable.playSegment('${tableId}', ${song.id}, 4)">
                                                <div class="segment-label">End</div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
        `;
        
        return previewRow;
    }
    
    // Setup audio player
    function setupAudioPlayer(tableId, songId) {
        const previewAudio = document.getElementById(`previewPlayer-${tableId}-${songId}`);
        if (!previewAudio) return;
        
        previewAudio.src = `/api/songs/${songId}/audio`;
        previewAudio.load();
        
        previewAudio.addEventListener('loadedmetadata', () => {
            const duration = previewAudio.duration;
            
            previewAudio.isAutoPlaying = true;
            previewAudio.isShortSong = duration < 30;
            previewAudio.currentSegment = 0;
            
            if (duration < 30) {
                previewAudio.loop = true;
                previewAudio.play();
            } else {
                const previewControls = document.getElementById(`previewControls-${tableId}-${songId}`);
                if (previewControls) {
                    previewControls.style.display = 'block';
                    
                    // Auto-start preview after a short delay
                    setTimeout(() => {
                        if (previewAudio.isAutoPlaying) {
                            playSegment(tableId, songId, 0);
                        }
                    }, 100);
                }
            }
        });
        
        previewAudio.addEventListener('error', () => {
            console.error('Error loading audio for song', songId);
        });
    }
    
    // Play segment
    function playSegment(tableId, songId, segmentIndex) {
        const previewAudio = document.getElementById(`previewPlayer-${tableId}-${songId}`);
        if (!previewAudio) return;
        
        const duration = previewAudio.duration;
        const segments = [
            { start: 0, duration: 10 },
            { start: duration * 0.25, duration: 10 },
            { start: duration * 0.5, duration: 10 },
            { start: duration * 0.75, duration: 10 },
            { start: Math.max(0, duration - 10), duration: 10 }
        ];
        
        const segment = segments[segmentIndex];
        if (!segment) return;
        
        // Clear any existing timeouts
        if (previewAudio.autoAdvanceTimeout) {
            clearTimeout(previewAudio.autoAdvanceTimeout);
        }
        
        previewAudio.currentTime = segment.start;
        previewAudio.currentSegment = segmentIndex;
        
        previewAudio.play().catch(err => {
            console.warn('Auto-play prevented by browser:', err);
        });
        
        // Stop after segment duration if auto-playing
        if (previewAudio.isAutoPlaying) {
            previewAudio.autoAdvanceTimeout = setTimeout(() => {
                if (!previewAudio.paused && previewAudio.isAutoPlaying) {
                    previewAudio.pause();
                    
                    // Auto-advance to next segment
                    const nextSegment = segmentIndex + 1;
                    if (nextSegment < segments.length) {
                        previewAudio.autoAdvanceTimeout = setTimeout(() => {
                            if (previewAudio.isAutoPlaying) {
                                playSegment(tableId, songId, nextSegment);
                            }
                        }, 1000);
                    } else {
                        // Loop back to start
                        previewAudio.autoAdvanceTimeout = setTimeout(() => {
                            if (previewAudio.isAutoPlaying) {
                                playSegment(tableId, songId, 0);
                            }
                        }, 1000);
                    }
                }
            }, segment.duration * 1000);
        }
        
        // Update active segment button
        const segmentButtons = document.querySelectorAll(`#segmentBar-${tableId}-${songId} .segment-btn`);
        segmentButtons.forEach((btn, index) => {
            btn.classList.toggle('active', index === segmentIndex);
            btn.classList.toggle('btn-primary', index === segmentIndex);
            btn.classList.toggle('btn-outline-primary', index !== segmentIndex);
        });
    }
    
    // Toggle auto play
    function toggleAutoPlay(tableId, songId) {
        const previewAudio = document.getElementById(`previewPlayer-${tableId}-${songId}`);
        const toggleButton = document.getElementById(`autoPlayToggle-${tableId}-${songId}`);
        
        if (!previewAudio || !toggleButton) return;
        
        previewAudio.isAutoPlaying = !previewAudio.isAutoPlaying;
        
        if (previewAudio.isAutoPlaying) {
            toggleButton.textContent = 'Stop Auto';
            toggleButton.className = 'btn btn-sm btn-danger';
        } else {
            toggleButton.textContent = 'Start Auto';
            toggleButton.className = 'btn btn-sm btn-success';
        }
    }
    
    // Stop all audio
    function stopAllAudio(tableId) {
        const audioElements = document.querySelectorAll(`#${tableId} audio`);
        audioElements.forEach(audio => {
            audio.pause();
            audio.currentTime = 0;
            audio.isAutoPlaying = false;
            
            // Clear any auto-advance timeouts
            if (audio.autoAdvanceTimeout) {
                clearTimeout(audio.autoAdvanceTimeout);
                audio.autoAdvanceTimeout = null;
            }
        });
    }
    
    // Edit song (to be implemented by parent)
    function editSong(tableId, songId) {
        const instance = instances.get(tableId);
        if (instance && instance.config.onEditSong) {
            instance.config.onEditSong(songId);
        }
    }
    
    // Manage tags (to be implemented by parent)
    function manageTags(tableId, songId) {
        const instance = instances.get(tableId);
        if (instance && instance.config.onManageTags) {
            instance.config.onManageTags(songId);
        }
    }
    
    // Get selected songs
    function getSelectedSongs(tableId) {
        const instance = instances.get(tableId);
        return instance ? Array.from(instance.selectedSongs) : [];
    }
    
    // Clear selection
    function clearSelection(tableId) {
        const instance = instances.get(tableId);
        if (instance) {
            instance.selectedSongs.clear();
            instance.lastSelectedIndex = null;
            renderTable(tableId);
            instance.onSelectionChange([]);
        }
    }
    

    
    function formatDuration(seconds) {
        if (!seconds) return '';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    function getColumnCount(config) {
        let count = 4; // Name, Artist, Album, Duration are always shown
        if (config.showCheckboxes) count++;
        if (config.showFolder) count++;
        if (config.showAudioFeatures) count += 2; // Tempo, Audio Features (Mood)
        if (config.showCreatedAt) count++;
        if (config.showTags) count++;
        return count;
    }
    
    // Public API
    return {
        init: init,
        setSongs: setSongs,
        filterSongs: filterSongs,
        renderTable: renderTable,
        toggleSongSelection: toggleSongSelection,
        handleShiftClick: handleShiftClick,
        toggleSelectAll: toggleSelectAll,
        sortTable: sortTable,
        previewSong: previewSong,
        closePreview: closePreview,
        playSegment: playSegment,
        toggleAutoPlay: toggleAutoPlay,
        editSong: editSong,
        manageTags: manageTags,
        getSelectedSongs: getSelectedSongs,
        clearSelection: clearSelection,
        goToPage: goToPage,
        getInstance: (tableId) => instances.get(tableId)
    };
})();
</script>
