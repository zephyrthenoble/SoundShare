{% extends "base.html" %}

{% block title %}Dynamic Playlist Info - SoundShare{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 id="playlistTitle">Loading...</h1>
                <p class="text-muted" id="playlistDescription">Loading playlist information...</p>
            </div>
            <div>
                <a href="/playlists" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left"></i> Back to Playlists
                </a>
                <button class="btn btn-outline-info me-2" onclick="rescanPlaylist()" id="rescanBtn">
                    <i class="fas fa-sync"></i> Rescan
                </button>
                <a href="#" id="editPlaylistBtn" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Edit Playlist
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Playlist Criteria Display -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#playlistCriteriaCollapse" aria-expanded="true" style="cursor: pointer;">
                <h5 class="mb-0">Playlist Criteria</h5>
                <i class="fas fa-chevron-down" id="criteriaChevron"></i>
            </div>
            <div class="collapse show" id="playlistCriteriaCollapse">
                <div class="card-body">
                <!-- Audio Features Row -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div id="audioFeatures">
                            <h6>Audio Features</h6>
                            <div id="audioFeaturesList">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tags and Groups Row -->
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success mb-3">Include Criteria</h6>
                        <div id="includeTags" class="mb-3">
                            <h6 class="h6 text-muted">Tags</h6>
                            <div id="includeTagsList">Loading...</div>
                        </div>
                        <div id="includeGroups">
                            <h6 class="h6 text-muted">Groups</h6>
                            <div id="includeGroupsList">Loading...</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger mb-3">Exclude Criteria</h6>
                        <div id="excludeTags" class="mb-3">
                            <h6 class="h6 text-muted">Tags</h6>
                            <div id="excludeTagsList">Loading...</div>
                        </div>
                        <div id="excludeGroups">
                            <h6 class="h6 text-muted">Groups</h6>
                            <div id="excludeGroupsList">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Media Player Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Media Player</h5>
            </div>
            <div class="card-body">
                <!-- Current Song Display -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div id="currentSongInfo" class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-music fa-2x text-muted"></i>
                            </div>
                            <div>
                                <h6 class="mb-1" id="currentSongTitle">No song selected</h6>
                                <small class="text-muted" id="currentSongArtist">Select a song to start playing</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-secondary" id="shuffleBtn" onclick="toggleShuffle()" title="Toggle Shuffle">
                                <i class="fas fa-random"></i>
                            </button>
                            <button class="btn btn-outline-secondary" id="autoplayBtn" onclick="toggleAutoplay()" title="Toggle Autoplay">
                                <i class="fas fa-forward"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Player Controls -->
                <div class="text-center mb-3">
                    <div class="btn-group" role="group">
                        <button class="btn btn-secondary" onclick="previousSong()" id="prevBtn" disabled>
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="skipBackward()" id="skipBackBtn" disabled>
                            <i class="fas fa-backward"></i> 20s
                        </button>
                        <button class="btn btn-success btn-lg" onclick="togglePlayPause()" id="playPauseBtn">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="skipForward()" id="skipForwardBtn" disabled>
                            20s <i class="fas fa-forward"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="nextSong()" id="nextBtn" disabled>
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>
                </div>

                <!-- Progress and Time -->
                <div class="row">
                    <div class="col-2 text-center">
                        <small id="currentTime">0:00</small>
                    </div>
                    <div class="col-8">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-2 text-center">
                        <small id="totalTime">0:00</small>
                    </div>
                </div>

                <!-- Hidden Audio Element -->
                <audio id="audioPlayer" style="display: none;"></audio>
            </div>
        </div>
    </div>
</div>

<!-- Playlist Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="totalSongs">0</h5>
                <p class="card-text text-muted">Total Songs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="sessionPlayed">0</h5>
                <p class="card-text text-muted">Played This Session</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="playlistProgress">0</h5>
                <p class="card-text text-muted">Playlist Progress</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <button class="btn btn-outline-primary" onclick="resetPlaylistTracking()">
                    <i class="fas fa-refresh"></i> Reset Progress
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Song Lists -->
<div class="row">
    <!-- Current Songs -->
    <div class="col-lg-8" id="playlistSongsCol">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Playlist Songs</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadPlaylistSongs()">
                    <i class="fas fa-refresh"></i> Refresh
                </button>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;" id="playlistSongsBody">
                <div id="playlistSongs">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading songs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session History -->
    <div class="col-lg-4" id="sessionHistoryCol">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#sessionHistoryCollapse" aria-expanded="true" style="cursor: pointer;">
                <div>
                    <h5 class="mb-0">Session History</h5>
                    <small class="text-muted">Recently played songs</small>
                </div>
                <i class="fas fa-chevron-left" id="historyChevron"></i>
            </div>
            <div class="collapse collapse-horizontal show" id="sessionHistoryCollapse">
                <div class="card-body" style="max-height: 500px; overflow-y: auto; min-width: 300px;">
                    <div id="sessionHistory">
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p>No songs played yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Song Info Modal -->
<div class="modal fade" id="songInfoModal" tabindex="-1" aria-labelledby="songInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="songInfoModalLabel">Song Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Title:</strong></td><td id="modalSongTitle">-</td></tr>
                            <tr><td><strong>Artist:</strong></td><td id="modalSongArtist">-</td></tr>
                            <tr><td><strong>Album:</strong></td><td id="modalSongAlbum">-</td></tr>
                            <tr><td><strong>Track:</strong></td><td id="modalSongTrack">-</td></tr>
                            <tr><td><strong>Duration:</strong></td><td id="modalSongDuration">-</td></tr>
                            <tr><td><strong>Genre:</strong></td><td id="modalSongGenre">-</td></tr>
                            <tr><td><strong>Year:</strong></td><td id="modalSongYear">-</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Audio Features</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Energy:</strong></td><td id="modalSongEnergy">-</td></tr>
                            <tr><td><strong>Valence:</strong></td><td id="modalSongValence">-</td></tr>
                            <tr><td><strong>Danceability:</strong></td><td id="modalSongDanceability">-</td></tr>
                        </table>
                        <h6>Tags</h6>
                        <div id="modalSongTags" class="mb-3">-</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6>File Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>File Path:</strong></td><td id="modalSongPath" class="text-break">-</td></tr>
                            <tr><td><strong>File Size:</strong></td><td id="modalSongSize">-</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables (used by shared library)
let playlistId = null;
let playlist = null;
let songs = [];

document.addEventListener('DOMContentLoaded', function() {
    // Get playlist ID from URL
    const path = window.location.pathname;
    playlistId = parseInt(path.split('/').pop());
    
    // Initialize shared player
    window.playlistPlayer.init(playlistId);
    
    // Load playlist data
    loadPlaylistData();
});

async function loadPlaylistData() {
    try {
        const response = await fetch(`/api/dynamic-playlists/${playlistId}`);
        if (!response.ok) {
            throw new Error('Playlist not found');
        }
        
        playlist = await response.json();
        
        // Update shared player data
        window.playlistPlayer.playlist = playlist;
        
        // Update UI
        window.playlistPlayer.updatePlaylistInfo();
        displayPlaylistCriteria();
        loadPlaylistSongs();
        
        // Set edit button link
        document.getElementById('editPlaylistBtn').href = `/playlists/edit/dynamic/${playlistId}`;
        
    } catch (error) {
        console.error('Error loading playlist:', error);
        alert('Error loading playlist. Returning to playlists page.');
        window.location.href = '/playlists';
    }
}

async function loadPlaylistSongs() {
    try {
        const response = await fetch(`/api/dynamic-playlists/${playlistId}/songs`);
        if (!response.ok) {
            throw new Error('Failed to load songs');
        }
        
        songs = await response.json();
        
        // Update shared player data
        window.playlistPlayer.songs = songs;
        
        renderPlaylistSongs();
        window.playlistPlayer.updateStatistics();
        
    } catch (error) {
        console.error('Error loading songs:', error);
        document.getElementById('playlistSongs').innerHTML = `
            <div class="text-center py-4 text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>Error loading songs</p>
            </div>
        `;
    }
}

function displayPlaylistCriteria() {
    // Display include tags
    const includeContainer = document.getElementById('includeTagsList');
    if (playlist.include_tags && playlist.include_tags.length > 0) {
        includeContainer.innerHTML = playlist.include_tags.map(tag => 
            `<span class="badge bg-success me-1">${tag.name}</span>`
        ).join('');
    } else {
        includeContainer.innerHTML = '<span class="text-muted">No include tags</span>';
    }
    
    // Display include groups
    const includeGroupsContainer = document.getElementById('includeGroupsList');
    if (playlist.include_groups && playlist.include_groups.length > 0) {
        includeGroupsContainer.innerHTML = playlist.include_groups.map(group => 
            `<span class="badge bg-info me-1">${group.name}</span>`
        ).join('');
    } else {
        includeGroupsContainer.innerHTML = '<span class="text-muted">No include groups</span>';
    }
    
    // Display exclude tags
    const excludeContainer = document.getElementById('excludeTagsList');
    if (playlist.exclude_tags && playlist.exclude_tags.length > 0) {
        excludeContainer.innerHTML = playlist.exclude_tags.map(tag => 
            `<span class="badge bg-danger me-1">${tag.name}</span>`
        ).join('');
    } else {
        excludeContainer.innerHTML = '<span class="text-muted">No exclude tags</span>';
    }
    
    // Display exclude groups
    const excludeGroupsContainer = document.getElementById('excludeGroupsList');
    if (playlist.exclude_groups && playlist.exclude_groups.length > 0) {
        excludeGroupsContainer.innerHTML = playlist.exclude_groups.map(group => 
            `<span class="badge bg-warning me-1">${group.name}</span>`
        ).join('');
    } else {
        excludeGroupsContainer.innerHTML = '<span class="text-muted">No exclude groups</span>';
    }
    
    // Display audio features
    const audioContainer = document.getElementById('audioFeaturesList');
    const features = [];
    
    if (playlist.energy_min !== null || playlist.energy_max !== null) {
        let energyText = 'Energy: ';
        if (playlist.energy_min !== null && playlist.energy_max !== null) {
            if (playlist.energy_min >= 0.7) energyText += 'High (0.7+)';
            else if (playlist.energy_min >= 0.3) energyText += 'Medium (0.3-0.7)';
            else energyText += 'Low (0.0-0.3)';
        } else {
            energyText += `${playlist.energy_min || 0} - ${playlist.energy_max || 1}`;
        }
        features.push(energyText);
    }
    
    if (playlist.valence_min !== null || playlist.valence_max !== null) {
        let valenceText = 'Mood: ';
        if (playlist.valence_min !== null && playlist.valence_max !== null) {
            if (playlist.valence_min >= 0.7) valenceText += 'Happy/Positive (0.7+)';
            else if (playlist.valence_min >= 0.3) valenceText += 'Neutral (0.3-0.7)';
            else valenceText += 'Sad/Negative (0.0-0.3)';
        } else {
            valenceText += `${playlist.valence_min || 0} - ${playlist.valence_max || 1}`;
        }
        features.push(valenceText);
    }
    
    if (playlist.danceability_min !== null || playlist.danceability_max !== null) {
        let danceText = 'Danceability: ';
        if (playlist.danceability_min !== null && playlist.danceability_max !== null) {
            if (playlist.danceability_min >= 0.7) danceText += 'High (0.7+)';
            else if (playlist.danceability_min >= 0.3) danceText += 'Medium (0.3-0.7)';
            else danceText += 'Low (0.0-0.3)';
        } else {
            danceText += `${playlist.danceability_min || 0} - ${playlist.danceability_max || 1}`;
        }
        features.push(danceText);
    }
    
    if (features.length > 0) {
        audioContainer.innerHTML = features.map(feature => 
            `<div class="mb-1"><span class="badge bg-info me-1">${feature}</span></div>`
        ).join('');
    } else {
        audioContainer.innerHTML = '<span class="text-muted">No audio feature filters</span>';
    }
}

function renderPlaylistSongs() {
    const container = document.getElementById('playlistSongs');
    
    if (songs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-music fa-2x mb-2"></i>
                <p>No songs match the current criteria</p>
            </div>
        `;
        return;
    }

    // Create table structure for better layout
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th width="30"></th>
                        <th width="250">Name</th>
                        <th width="150">Artist</th>
                        <th width="150">Album</th>
                        <th width="80">Duration</th>
                        <th width="120">Tags</th>
                        <th width="50">Info</th>
                    </tr>
                </thead>
                <tbody id="songTableBody">
                </tbody>
            </table>
        </div>
    `;

    const tbody = document.getElementById('songTableBody');
    tbody.innerHTML = songs.map((song, index) => {
        const formatDuration = (seconds) => {
            if (!seconds) return '';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        return `
            <tr class="song-row" data-song-id="${song.id}" data-index="${index}" draggable="true">
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="playSong(${index})" title="Play Song">
                        <i class="fas fa-play"></i>
                    </button>
                </td>
                <td class="fw-bold" title="${song.display_name}">${song.display_name}</td>
                <td class="text-muted" title="${song.artist || ''}">${song.artist || 'Unknown Artist'}</td>
                <td class="text-muted" title="${song.album || ''}">${song.album || ''}</td>
                <td class="text-muted">${formatDuration(song.duration)}</td>
                <td>
                    ${song.tags && song.tags.length > 0 ? 
                        song.tags.slice(0, 2).map(tag => 
                            `<span class="badge bg-secondary me-1" style="font-size: 0.7em;">${tag.name}</span>`
                        ).join('') + (song.tags.length > 2 ? `<span class="text-muted">+${song.tags.length - 2}</span>` : '')
                        : '<span class="text-muted">-</span>'
                    }
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="showPlaylistSongInfo(${song.id})" title="Song Info">
                        <i class="fas fa-info"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    // Initialize drag and drop for reordering
    initializeDragAndDrop();
}

async function rescanPlaylist() {
    const button = document.getElementById('rescanBtn');
    const originalHtml = button.innerHTML;
    
    try {
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rescanning...';
        button.disabled = true;
        
        const response = await fetch(`/api/dynamic-playlists/${playlistId}/rescan`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Show success message
        alert(`Rescan completed!\n\nFound: ${result.song_count} songs\nFiles checked: ${result.files_checked}\nMissing files: ${result.missing_files}`);
        
        // Reload songs
        await loadPlaylistSongs();
        
    } catch (error) {
        console.error('Error rescanning playlist:', error);
        alert('Error rescanning playlist. Please try again.');
    } finally {
        // Restore button state
        button.innerHTML = originalHtml;
        button.disabled = false;
    }
}

// Media player functions (same as static playlist)
function setupAudioEventListeners() {
    audioPlayer.addEventListener('loadedmetadata', function() {
        updateTimeDisplay();
    });
    
    audioPlayer.addEventListener('timeupdate', function() {
        updateProgressBar();
        updateTimeDisplay();
    });
    
    audioPlayer.addEventListener('ended', function() {
        onSongEnded();
    });
    
    audioPlayer.addEventListener('error', function() {
        console.error('Audio playback error');
        nextSong();
    });
}

function togglePlayPause() {
    if (currentSongIndex === -1) {
        playSong(0);
        return;
    }
    
    if (isPlaying) {
        pauseSong();
    } else {
        resumeSong();
    }
}

function playSong(index) {
    if (index < 0 || index >= songs.length) return;
    
    const song = songs[index];
    currentSongIndex = index;
    
    document.getElementById('currentSongTitle').textContent = song.display_name;
    document.getElementById('currentSongArtist').textContent = song.artist || 'Unknown Artist';
    
    audioPlayer.src = `/api/songs/${song.id}/stream`;
    audioPlayer.play();
    isPlaying = true;
    
    document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
    enablePlayerControls();
    
    addToSessionHistory(song);
    addToPlaylistTracking(song);
    updateStatistics();
    highlightCurrentSong();
}

function pauseSong() {
    audioPlayer.pause();
    isPlaying = false;
    document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
}

function resumeSong() {
    audioPlayer.play();
    isPlaying = true;
    document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
}

function nextSong() {
    if (songs.length === 0) return;
    
    let nextIndex;
    
    if (isShuffleMode) {
        nextIndex = getNextShuffleSong();
    } else {
        nextIndex = (currentSongIndex + 1) % songs.length;
        if (nextIndex === 0) {
            resetPlaylistTracking();
        }
    }
    
    playSong(nextIndex);
}

function previousSong() {
    if (sessionHistory.length > 1) {
        sessionHistory.pop();
        const prevSong = sessionHistory[sessionHistory.length - 1];
        const prevIndex = songs.findIndex(s => s.id === prevSong.id);
        
        if (prevIndex !== -1) {
            currentSongIndex = prevIndex;
            playSong(prevIndex);
        }
    }
}

function getNextShuffleSong() {
    const unplayedSongs = songs.filter(song => 
        !playlistTracking.some(tracked => tracked.id === song.id)
    );
    
    if (unplayedSongs.length === 0) {
        resetPlaylistTracking();
        return Math.floor(Math.random() * songs.length);
    }
    
    const randomUnplayed = unplayedSongs[Math.floor(Math.random() * unplayedSongs.length)];
    return songs.findIndex(song => song.id === randomUnplayed.id);
}

function skipForward() {
    audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 20, audioPlayer.duration);
}

function skipBackward() {
    audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 20, 0);
}

function toggleShuffle() {
    isShuffleMode = !isShuffleMode;
    const shuffleBtn = document.getElementById('shuffleBtn');
    
    if (isShuffleMode) {
        shuffleBtn.classList.remove('btn-outline-secondary');
        shuffleBtn.classList.add('btn-secondary');
    } else {
        shuffleBtn.classList.remove('btn-secondary');
        shuffleBtn.classList.add('btn-outline-secondary');
    }
}

function toggleAutoplay() {
    isAutoplay = !isAutoplay;
    const autoplayBtn = document.getElementById('autoplayBtn');
    
    if (isAutoplay) {
        autoplayBtn.classList.remove('btn-outline-secondary');
        autoplayBtn.classList.add('btn-secondary');
    } else {
        autoplayBtn.classList.remove('btn-secondary');
        autoplayBtn.classList.add('btn-outline-secondary');
    }
}

function onSongEnded() {
    if (isAutoplay) {
        nextSong();
    } else {
        isPlaying = false;
        document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
    }
}

function addToSessionHistory(song) {
    sessionHistory.push({
        ...song,
        playedAt: new Date()
    });
    renderSessionHistory();
}

function addToPlaylistTracking(song) {
    if (!playlistTracking.some(tracked => tracked.id === song.id)) {
        playlistTracking.push(song);
    }
}

function resetPlaylistTracking() {
    playlistTracking = [];
    updateStatistics();
}

function renderSessionHistory() {
    const container = document.getElementById('sessionHistory');
    
    if (sessionHistory.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-history fa-2x mb-2"></i>
                <p>No songs played yet</p>
            </div>
        `;
        return;
    }
    
    const recentHistory = sessionHistory.slice(-10).reverse();
    
    container.innerHTML = recentHistory.map((entry, index) => `
        <div class="d-flex align-items-center p-2 mb-2 border rounded">
            <div class="me-2">
                <small class="badge bg-secondary">${sessionHistory.length - index}</small>
            </div>
            <div class="flex-grow-1">
                <div class="fw-bold small">${entry.display_name}</div>
                <small class="text-muted">${entry.artist || 'Unknown Artist'}</small>
            </div>
            <div class="ms-2">
                <small class="text-muted">${entry.playedAt.toLocaleTimeString()}</small>
            </div>
        </div>
    `).join('');
}

function updateStatistics() {
    document.getElementById('totalSongs').textContent = songs.length;
    document.getElementById('sessionPlayed').textContent = sessionHistory.length;
    document.getElementById('playlistProgress').textContent = `${playlistTracking.length}/${songs.length}`;
}

function enablePlayerControls() {
    document.getElementById('prevBtn').disabled = sessionHistory.length <= 1;
    document.getElementById('skipBackBtn').disabled = false;
    document.getElementById('skipForwardBtn').disabled = false;
    document.getElementById('nextBtn').disabled = songs.length <= 1;
}

function updateProgressBar() {
    if (audioPlayer.duration) {
        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }
}

function updateTimeDisplay() {
    const current = formatTime(audioPlayer.currentTime);
    const total = formatTime(audioPlayer.duration);
    
    document.getElementById('currentTime').textContent = current;
    document.getElementById('totalTime').textContent = total;
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function highlightCurrentSong() {
    document.querySelectorAll('.song-item').forEach(item => {
        item.classList.remove('bg-primary', 'text-white');
    });
    
    if (currentSongIndex >= 0) {
        const currentItem = document.querySelector(`[data-index="${currentSongIndex}"]`);
        if (currentItem) {
            currentItem.classList.add('bg-primary', 'text-white');
        }
    }
}

// Initialize drag and drop for song reordering
function initializeDragAndDrop() {
    const tbody = document.getElementById('songTableBody');
    if (!tbody) return;

    let draggedElement = null;
    let draggedIndex = null;

    tbody.querySelectorAll('.song-row').forEach(row => {
        row.addEventListener('dragstart', (e) => {
            draggedElement = e.target.closest('.song-row');
            draggedIndex = parseInt(draggedElement.dataset.index);
            e.dataTransfer.effectAllowed = 'move';
            draggedElement.style.opacity = '0.5';
        });

        row.addEventListener('dragend', (e) => {
            e.target.style.opacity = '';
            draggedElement = null;
            draggedIndex = null;
        });

        row.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });

        row.addEventListener('drop', (e) => {
            e.preventDefault();
            if (!draggedElement) return;

            const targetRow = e.target.closest('.song-row');
            if (!targetRow || targetRow === draggedElement) return;

            const targetIndex = parseInt(targetRow.dataset.index);
            
            // Reorder songs array
            const draggedSong = songs.splice(draggedIndex, 1)[0];
            songs.splice(targetIndex, 0, draggedSong);
            
            // Re-render the table
            renderPlaylistSongs();
        });
    });
}

// Show song info modal
async function showPlaylistSongInfo(songId) {
    try {
        const response = await fetch(`/api/songs/${songId}`);
        if (!response.ok) {
            throw new Error('Failed to load song details');
        }
        
        const song = await response.json();
        
        // Populate modal with song information
        document.getElementById('modalSongTitle').textContent = song.display_name || '-';
        document.getElementById('modalSongArtist').textContent = song.artist || '-';
        document.getElementById('modalSongAlbum').textContent = song.album || '-';
        document.getElementById('modalSongTrack').textContent = song.track_number ? `Track ${song.track_number}` : '-';
        document.getElementById('modalSongDuration').textContent = song.duration ? formatTime(song.duration) : '-';
        document.getElementById('modalSongGenre').textContent = song.genre || '-';
        document.getElementById('modalSongYear').textContent = song.year || '-';
        
        // Audio features
        document.getElementById('modalSongEnergy').textContent = song.energy ? `${(song.energy * 100).toFixed(1)}%` : '-';
        document.getElementById('modalSongValence').textContent = song.valence ? `${(song.valence * 100).toFixed(1)}%` : '-';
        document.getElementById('modalSongDanceability').textContent = song.danceability ? `${(song.danceability * 100).toFixed(1)}%` : '-';
        
        // Tags
        const tagsContainer = document.getElementById('modalSongTags');
        if (song.tags && song.tags.length > 0) {
            tagsContainer.innerHTML = song.tags.map(tag => 
                `<span class="badge bg-secondary me-1">${tag.name}</span>`
            ).join('');
        } else {
            tagsContainer.innerHTML = '<span class="text-muted">No tags</span>';
        }
        
        // File info
        document.getElementById('modalSongPath').textContent = song.file_path || '-';
        document.getElementById('modalSongSize').textContent = song.file_size ? formatFileSize(song.file_size) : '-';
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('songInfoModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error loading song details:', error);
        alert('Error loading song details');
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Format time
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Handle collapse chevron rotation
document.addEventListener('DOMContentLoaded', function() {
    // Criteria collapse handler
    const criteriaCollapse = document.getElementById('playlistCriteriaCollapse');
    const criteriaChevron = document.getElementById('criteriaChevron');
    
    if (criteriaCollapse && criteriaChevron) {
        criteriaCollapse.addEventListener('show.bs.collapse', () => {
            criteriaChevron.classList.remove('fa-chevron-right');
            criteriaChevron.classList.add('fa-chevron-down');
        });
        
        criteriaCollapse.addEventListener('hide.bs.collapse', () => {
            criteriaChevron.classList.remove('fa-chevron-down');
            criteriaChevron.classList.add('fa-chevron-right');
        });
    }
    
    // History collapse handler
    const historyCollapse = document.getElementById('sessionHistoryCollapse');
    const historyChevron = document.getElementById('historyChevron');
    
    if (historyCollapse && historyChevron) {
        historyCollapse.addEventListener('show.bs.collapse', () => {
            historyChevron.classList.remove('fa-chevron-right');
            historyChevron.classList.add('fa-chevron-left');
        });
        
        historyCollapse.addEventListener('hide.bs.collapse', () => {
            historyChevron.classList.remove('fa-chevron-left');
            historyChevron.classList.add('fa-chevron-right');
        });
    }
    
    // Session history collapse handler for expanding playlist songs
    if (historyCollapse) {
        historyCollapse.addEventListener('hidden.bs.collapse', () => {
            document.getElementById('playlistSongsCol').className = 'col-lg-12';
        });
        
        historyCollapse.addEventListener('shown.bs.collapse', () => {
            document.getElementById('playlistSongsCol').className = 'col-lg-8';
        });
    }
});
</script>

<style>
.song-item:hover {
    background-color: #f8f9fa;
}

.song-item.bg-primary:hover {
    background-color: #0d6efd !important;
}
</style>
{% endblock %}
