{% extends "base.html" %}

{% block title %}Songs - SoundShare{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <h1 class="me-3">Song Management</h1>
        <span class="badge bg-secondary fs-6" id="filteredSongCount">0 songs</span>
    </div>
    <button class="btn btn-warning" id="scanLibraryBtn">
        <i class="fas fa-search"></i> Scan Library
    </button>
</div>

<!-- Search and Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="searchInput" class="form-label">Search Songs</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search by name, artist, album...">
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-3">
                    <label for="artistFilter" class="form-label">Filter by Artist</label>
                    <select class="form-select" id="artistFilter">
                        <option value="">All Artists</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-3">
                    <label for="albumFilter" class="form-label">Filter by Album</label>
                    <select class="form-select" id="albumFilter">
                        <option value="">All Albums</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-3">
                    <label for="folderFilter" class="form-label">Filter by Folder</label>
                    <select class="form-select" id="folderFilter">
                        <option value="">All Folders</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-3">
                    <label for="tempoFilter" class="form-label">Filter by Tempo</label>
                    <select class="form-select" id="tempoFilter">
                        <option value="">All Tempos</option>
                        <option value="slow">Slow (60-90 BPM)</option>
                        <option value="moderate">Moderate (90-120 BPM)</option>
                        <option value="medium">Medium (120-140 BPM)</option>
                        <option value="fast">Fast (140-180 BPM)</option>
                        <option value="very-fast">Very Fast (180+ BPM)</option>
                    </select>
                </div>
            </div>
            <div class="col-md-1">
                <div class="mb-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="energyFilter" class="form-label">Energy Range</label>
                    <select class="form-select" id="energyFilter">
                        <option value="">Any Energy</option>
                        <option value="high">High Energy (70%+)</option>
                        <option value="medium">Medium Energy (30-70%)</option>
                        <option value="low">Low Energy (0-30%)</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="valenceFilter" class="form-label">Mood Range</label>
                    <select class="form-select" id="valenceFilter">
                        <option value="">Any Mood</option>
                        <option value="positive">Positive (70%+)</option>
                        <option value="neutral">Neutral (30-70%)</option>
                        <option value="melancholy">Melancholy (0-30%)</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="danceabilityFilter" class="form-label">Danceability</label>
                    <select class="form-select" id="danceabilityFilter">
                        <option value="">Any Danceability</option>
                        <option value="high">High (70%+)</option>
                        <option value="medium">Medium (30-70%)</option>
                        <option value="low">Low (0-30%)</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="durationFilter" class="form-label">Duration</label>
                    <select class="form-select" id="durationFilter">
                        <option value="">Any Duration</option>
                        <option value="sound_effects">Sound Effects (0-10s)</option>
                        <option value="short">Short (10-60s)</option>
                        <option value="long">Long (60s+)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Toolbar -->
<div class="card mb-3" id="bulkActionsToolbar" style="display: none;">
    <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span id="selectedCount" class="fw-bold">0 songs selected</span>
            </div>
            <div class="btn-group">
                <button class="btn btn-sm btn-primary" onclick="addSelectedToPlaylist()">
                    <i class="fas fa-plus"></i> Add to Playlist
                </button>
                <button class="btn btn-sm btn-secondary" onclick="tagSelectedSongs()">
                    <i class="fas fa-tags"></i> Tag Songs
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteSelectedSongs()">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                    <i class="fas fa-times"></i> Clear Selection
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        {% include "components/song_table.html" %}
    </div>
</div>

<!-- Edit Song Modal -->
<div class="modal fade" id="editSongModal" tabindex="-1" aria-labelledby="editSongModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSongModalLabel">Edit Song</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSongForm">
                    <input type="hidden" id="editSongId" />
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDisplayName" class="form-label">Display Name</label>
                                <input type="text" class="form-control" id="editDisplayName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="editYear" min="1900" max="2100" placeholder="YYYY">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editArtist" class="form-label">Artist</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editArtist" list="artistDatalist" placeholder="Select or type new artist">
                                    <button class="btn btn-outline-secondary" type="button" id="clearArtist" title="Clear Artist">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <datalist id="artistDatalist">
                                    <!-- Artists will be populated here -->
                                </datalist>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAlbum" class="form-label">Album</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editAlbum" list="albumDatalist" placeholder="Select or type new album">
                                    <button class="btn btn-outline-secondary" type="button" id="clearAlbum" title="Clear Album">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <datalist id="albumDatalist">
                                    <!-- Albums will be populated here -->
                                </datalist>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">File Information</label>
                                <div class="bg-light p-3 rounded">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">
                                                <div><strong>Filename:</strong> <span id="editFilename"></span></div>
                                                <div><strong>Duration:</strong> <span id="editDuration"></span></div>
                                                <div><strong>File Size:</strong> <span id="editFileSize"></span></div>
                                            </small>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">
                                                <div><strong>Tempo:</strong> <span id="editTempo"></span></div>
                                                <div><strong>Key:</strong> <span id="editKey"></span></div>
                                                <div><strong>Created:</strong> <span id="editCreatedAt"></span></div>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSongBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
let songs = [];
let filteredSongs = [];
let tags = [];
let playlists = [];
let songTableInstance;

// Load songs and tags on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the song table component
    initializeSongTable();
    
    loadSongs();
    loadTags();
    loadPlaylists();
    setupFilterListeners();
    setupModalListeners();
    
    // Bind scan library button
    document.getElementById('scanLibraryBtn').addEventListener('click', function() {
        scanLibrary();
    });
});

function setupModalListeners() {
    // Save song button
    document.getElementById('saveSongBtn').addEventListener('click', saveSongChanges);
    
    // Clear artist button
    document.getElementById('clearArtist').addEventListener('click', function() {
        document.getElementById('editArtist').value = '';
    });
    
    // Clear album button
    document.getElementById('clearAlbum').addEventListener('click', function() {
        document.getElementById('editAlbum').value = '';
    });
    
    // Year input validation
    const yearInput = document.getElementById('editYear');
    yearInput.addEventListener('input', function() {
        let value = this.value;
        if (value && (value < 1900 || value > 2100)) {
            this.setCustomValidity('Year must be between 1900 and 2100');
        } else {
            this.setCustomValidity('');
        }
    });
}

function initializeSongTable() {
    // Initialize the song table component
    songTableInstance = songTable.init({
        tableId: 'songsTable',
        showCheckboxes: true,
        showFolder: true,
        showAudioFeatures: true,
        showTags: true,
        showCreatedAt: true,
        showEditButton: true,
        showTagManagement: true,
        onSongClick: (song, row) => {
            // Handle song click if needed
        },
        onSelectionChange: (selectedIds) => {
            updateBulkActionsToolbar(selectedIds);
        },
        onEditSong: (songId) => {
            editSong(songId);
        },
        onManageTags: (songId) => {
            manageSongTags(songId);
        }
    });
}

async function loadSongs() {
    try {
        const response = await fetch('/api/songs/with-folders');
        songs = await response.json();
        filteredSongs = [...songs];
        populateFilterDropdowns();
        
        // Update the song table component
        songTable.setSongs('songsTable', filteredSongs);
    } catch (error) {
        console.error('Error loading songs:', error);
    }
}

async function loadTags() {
    try {
        const response = await fetch('/api/tags/');
        tags = await response.json();
    } catch (error) {
        console.error('Error loading tags:', error);
    }
}

async function loadPlaylists() {
    try {
        const response = await fetch('/api/playlists/');
        playlists = await response.json();
    } catch (error) {
        console.error('Error loading playlists:', error);
    }
}

// Filtering and Search Functions
function populateFilterDropdowns() {
    const artists = [...new Set(songs.map(song => song.artist).filter(Boolean))].sort();
    const albums = [...new Set(songs.map(song => song.album).filter(Boolean))].sort();
    const folders = [...new Set(songs.map(song => song.folder).filter(Boolean))].sort();
    
    const artistSelect = document.getElementById('artistFilter');
    const albumSelect = document.getElementById('albumFilter');
    const folderSelect = document.getElementById('folderFilter');
    
    artistSelect.innerHTML = '<option value="">All Artists</option>';
    artists.forEach(artist => {
        artistSelect.innerHTML += `<option value="${artist}">${artist}</option>`;
    });
    
    albumSelect.innerHTML = '<option value="">All Albums</option>';
    albums.forEach(album => {
        albumSelect.innerHTML += `<option value="${album}">${album}</option>`;
    });
    
    folderSelect.innerHTML = '<option value="">All Folders</option>';
    folders.forEach(folder => {
        folderSelect.innerHTML += `<option value="${folder}">${folder}</option>`;
    });
}

function setupFilterListeners() {
    const searchInput = document.getElementById('searchInput');
    const artistFilter = document.getElementById('artistFilter');
    const albumFilter = document.getElementById('albumFilter');
    const folderFilter = document.getElementById('folderFilter');
    const tempoFilter = document.getElementById('tempoFilter');
    const energyFilter = document.getElementById('energyFilter');
    const valenceFilter = document.getElementById('valenceFilter');
    const danceabilityFilter = document.getElementById('danceabilityFilter');
    const durationFilter = document.getElementById('durationFilter');
    
    searchInput.addEventListener('input', applyFilters);
    artistFilter.addEventListener('change', applyFilters);
    albumFilter.addEventListener('change', applyFilters);
    folderFilter.addEventListener('change', applyFilters);
    tempoFilter.addEventListener('change', applyFilters);
    energyFilter.addEventListener('change', applyFilters);
    valenceFilter.addEventListener('change', applyFilters);
    danceabilityFilter.addEventListener('change', applyFilters);
    durationFilter.addEventListener('change', applyFilters);
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const selectedArtist = document.getElementById('artistFilter').value;
    const selectedAlbum = document.getElementById('albumFilter').value;
    const selectedFolder = document.getElementById('folderFilter').value;
    const selectedTempo = document.getElementById('tempoFilter').value;
    const selectedEnergy = document.getElementById('energyFilter').value;
    const selectedValence = document.getElementById('valenceFilter').value;
    const selectedDanceability = document.getElementById('danceabilityFilter').value;
    const selectedDuration = document.getElementById('durationFilter').value;
    
    filteredSongs = songs.filter(song => {
        const matchesSearch = !searchTerm || 
            song.display_name.toLowerCase().includes(searchTerm) ||
            (song.artist && song.artist.toLowerCase().includes(searchTerm)) ||
            (song.album && song.album.toLowerCase().includes(searchTerm)) ||
            song.filename.toLowerCase().includes(searchTerm) ||
            (song.tags && song.tags.some(tag => tag.name.toLowerCase().includes(searchTerm)));
        
        const matchesArtist = !selectedArtist || song.artist === selectedArtist;
        const matchesAlbum = !selectedAlbum || song.album === selectedAlbum;
        const matchesFolder = !selectedFolder || song.folder === selectedFolder;
        
        // Tempo filter
        let matchesTempo = true;
        if (selectedTempo && song.tempo !== null && song.tempo !== undefined) {
            const tempo = song.tempo;
            if (selectedTempo === 'slow' && (tempo < 60 || tempo >= 90)) matchesTempo = false;
            if (selectedTempo === 'moderate' && (tempo < 90 || tempo >= 120)) matchesTempo = false;
            if (selectedTempo === 'medium' && (tempo < 120 || tempo >= 140)) matchesTempo = false;
            if (selectedTempo === 'fast' && (tempo < 140 || tempo >= 180)) matchesTempo = false;
            if (selectedTempo === 'very-fast' && tempo < 180) matchesTempo = false;
        }
        
        // Energy filter
        let matchesEnergy = true;
        if (selectedEnergy && song.energy !== null && song.energy !== undefined) {
            const energyPercent = song.energy * 100;
            if (selectedEnergy === 'high' && energyPercent < 70) matchesEnergy = false;
            if (selectedEnergy === 'medium' && (energyPercent < 30 || energyPercent >= 70)) matchesEnergy = false;
            if (selectedEnergy === 'low' && energyPercent >= 30) matchesEnergy = false;
        }
        
        // Valence (mood) filter
        let matchesValence = true;
        if (selectedValence && song.valence !== null && song.valence !== undefined) {
            const valencePercent = song.valence * 100;
            if (selectedValence === 'positive' && valencePercent < 70) matchesValence = false;
            if (selectedValence === 'neutral' && (valencePercent < 30 || valencePercent >= 70)) matchesValence = false;
            if (selectedValence === 'melancholy' && valencePercent >= 30) matchesValence = false;
        }
        
        // Danceability filter
        let matchesDanceability = true;
        if (selectedDanceability && song.danceability !== null && song.danceability !== undefined) {
            const danceabilityPercent = song.danceability * 100;
            if (selectedDanceability === 'high' && danceabilityPercent < 70) matchesDanceability = false;
            if (selectedDanceability === 'medium' && (danceabilityPercent < 30 || danceabilityPercent >= 70)) matchesDanceability = false;
            if (selectedDanceability === 'low' && danceabilityPercent >= 30) matchesDanceability = false;
        }
        
        // Duration filter
        let matchesDuration = true;
        if (selectedDuration && song.duration !== null && song.duration !== undefined) {
            if (selectedDuration === 'sound_effects' && song.duration >= 10) matchesDuration = false;
            if (selectedDuration === 'short' && song.duration >= 60) matchesDuration = false;
            if (selectedDuration === 'long' && song.duration < 60) matchesDuration = false;
        }
        
        return matchesSearch && matchesArtist && matchesAlbum && matchesFolder && matchesTempo &&
               matchesEnergy && matchesValence && matchesDanceability && matchesDuration;
    });
    
    updateFilteredSongCount();
    
    // Update the song table component
    songTable.setSongs('songsTable', filteredSongs);
}

function updateFilteredSongCount() {
    const countElement = document.getElementById('filteredSongCount');
    const count = filteredSongs.length;
    countElement.textContent = `${count} song${count === 1 ? '' : 's'}`;
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('artistFilter').value = '';
    document.getElementById('albumFilter').value = '';
    document.getElementById('folderFilter').value = '';
    document.getElementById('tempoFilter').value = '';
    document.getElementById('energyFilter').value = '';
    document.getElementById('valenceFilter').value = '';
    document.getElementById('danceabilityFilter').value = '';
    document.getElementById('durationFilter').value = '';
    applyFilters();
}

async function scanLibrary() {
    try {
        const response = await fetch('/api/library/scan', { method: 'POST' });
        if (response.ok) {
            const data = await response.json();
            notificationSystem.success("Scan Complete", `Found ${data.songs_added} new songs`);
            loadSongs(); // Reload songs after scan
        } else {
            notificationSystem.error("Scan Failed", "Failed to scan library");
        }
    } catch (error) {
        console.error('Error scanning library:', error);
        notificationSystem.error("Scan Error", "Error occurred while scanning library");
    }
}

// Bulk Actions Functions
function updateBulkActionsToolbar(selectedIds) {
    const toolbar = document.getElementById('bulkActionsToolbar');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedIds.length > 0) {
        toolbar.style.display = 'block';
        selectedCount.textContent = `${selectedIds.length} song${selectedIds.length === 1 ? '' : 's'} selected`;
    } else {
        toolbar.style.display = 'none';
    }
}

function clearSelection() {
    songTable.clearSelection('songsTable');
}

function addSelectedToPlaylist() {
    const selectedIds = songTable.getSelectedSongs('songsTable');
    if (selectedIds.length === 0) {
        notificationSystem.warning("No Selection", "Please select songs first");
        return;
    }
    // TODO: Implement add to playlist functionality
    notificationSystem.info("Add to Playlist", `Would add ${selectedIds.length} songs to playlist`);
}

function tagSelectedSongs() {
    const selectedIds = songTable.getSelectedSongs('songsTable');
    if (selectedIds.length === 0) {
        notificationSystem.warning("No Selection", "Please select songs first");
        return;
    }
    // TODO: Implement bulk tagging functionality
    notificationSystem.info("Tag Songs", `Would tag ${selectedIds.length} songs`);
}

function deleteSelectedSongs() {
    const selectedIds = songTable.getSelectedSongs('songsTable');
    if (selectedIds.length === 0) {
        notificationSystem.warning("No Selection", "Please select songs first");
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selectedIds.length} selected song${selectedIds.length === 1 ? '' : 's'}?`)) {
        // TODO: Implement delete functionality
        notificationSystem.info("Delete Songs", `Would delete ${selectedIds.length} songs`);
    }
}

function editSong(songId) {
    console.log('Edit song called with ID:', songId);
    console.log('Available songs:', songs.length);
    
    const song = songs.find(s => s.id === songId);
    if (!song) {
        console.error('Song not found in songs array. Available IDs:', songs.map(s => s.id));
        notificationSystem.error("Error", "Song not found");
        return;
    }
    
    console.log('Found song:', song);
    
    // Populate the modal with current song data
    document.getElementById('editSongId').value = song.id;
    document.getElementById('editDisplayName').value = song.display_name || '';
    document.getElementById('editArtist').value = song.artist || '';
    document.getElementById('editAlbum').value = song.album || '';
    document.getElementById('editYear').value = song.year || '';
    
    // Populate read-only fields
    document.getElementById('editFilename').textContent = song.filename || '';
    document.getElementById('editDuration').textContent = formatDuration(song.duration) || '';
    document.getElementById('editFileSize').textContent = song.file_size ? `${Math.round(song.file_size / 1024)} KB` : '';
    document.getElementById('editTempo').textContent = song.tempo ? `${Math.round(song.tempo)} BPM` : '';
    document.getElementById('editKey').textContent = song.key || '';
    document.getElementById('editCreatedAt').textContent = song.created_at ? formatDateTime(song.created_at) : '';
    
    // Populate artist and album datalists
    populateEditDataLists();
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editSongModal'));
    modal.show();
}

function populateEditDataLists() {
    // Get unique artists and albums from current songs
    const artists = [...new Set(songs.map(song => song.artist).filter(Boolean))].sort();
    const albums = [...new Set(songs.map(song => song.album).filter(Boolean))].sort();
    
    // Populate artist datalist
    const artistDatalist = document.getElementById('artistDatalist');
    artistDatalist.innerHTML = '';
    artists.forEach(artist => {
        const option = document.createElement('option');
        option.value = artist;
        artistDatalist.appendChild(option);
    });
    
    // Populate album datalist
    const albumDatalist = document.getElementById('albumDatalist');
    albumDatalist.innerHTML = '';
    albums.forEach(album => {
        const option = document.createElement('option');
        option.value = album;
        albumDatalist.appendChild(option);
    });
}

async function saveSongChanges() {
    const songId = document.getElementById('editSongId').value;
    const displayName = document.getElementById('editDisplayName').value.trim();
    const artist = document.getElementById('editArtist').value.trim();
    const album = document.getElementById('editAlbum').value.trim();
    const year = document.getElementById('editYear').value;
    
    if (!displayName) {
        notificationSystem.error("Validation Error", "Display name is required");
        return;
    }
    
    console.log('Saving song changes:', { songId, displayName, artist, album, year });
    
    // Create form data
    const formData = new FormData();
    formData.append('display_name', displayName);
    formData.append('artist', artist || '');  // Send empty string instead of omitting
    formData.append('album', album || '');     // Send empty string instead of omitting
    formData.append('year', year || '');       // Send empty string instead of omitting
    
    // Log form data for debugging
    console.log('Form data entries:');
    for (let [key, value] of formData.entries()) {
        console.log(key, value);
    }
    
    try {
        const response = await fetch(`/api/songs/${songId}`, {
            method: 'PUT',
            body: formData
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (response.ok) {
            const updatedSong = await response.json();
            console.log('Updated song:', updatedSong);
            
            // Update the song in our local array
            const songIndex = songs.findIndex(s => s.id === parseInt(songId));
            if (songIndex !== -1) {
                songs[songIndex] = { ...songs[songIndex], ...updatedSong };
                
                // Update filtered songs if this song is visible
                const filteredIndex = filteredSongs.findIndex(s => s.id === parseInt(songId));
                if (filteredIndex !== -1) {
                    filteredSongs[filteredIndex] = { ...filteredSongs[filteredIndex], ...updatedSong };
                }
            }
            
            // Refresh the table
            songTable.setSongs('songsTable', filteredSongs);
            
            // Refresh dropdowns
            populateFilterDropdowns();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editSongModal'));
            modal.hide();
            
            notificationSystem.success("Success", "Song updated successfully");
        } else {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            try {
                const error = JSON.parse(errorText);
                notificationSystem.error("Update Failed", error.detail || "Failed to update song");
            } catch (e) {
                notificationSystem.error("Update Failed", `Server error: ${response.status} - ${errorText}`);
            }
        }
    } catch (error) {
        console.error('Error updating song:', error);
        notificationSystem.error("Error", "An error occurred while updating the song: " + error.message);
    }
}

function formatDuration(seconds) {
    if (!seconds) return '';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '';
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function manageSongTags(songId) {
    // TODO: Implement tag management functionality
    notificationSystem.info("Manage Tags", `Would manage tags for song ${songId}`);
}
</script>
{% endblock %}
